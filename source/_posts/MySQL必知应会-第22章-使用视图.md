---
title: MySQL必知应会-第22章-使用视图
date: 2018-04-13 18:06:52
tags:
 - mysql
 - 数据库
categories:
 - mysql
 - 数据库
---

使 用 视 图本章将介绍视图究竟是什么，它们怎样工作，何时使用它们。我们还将看到如何利用视图简化前面章节中执行的某些SQL操作。22.1 视图需要MySQL 5 MySQL 5添加了对视图的支持。因此，本章内容适用于MySQL 5及以后的版本。视图是虚拟的表。与包含数据的表不一样，视图只包含使用时动态检索数据的查询。理解视图的最好方法是看一个例子。第15章中用下面的SELECT语句从3个表中检索数据：此查询用来检索订购了某个特定产品的客户。任何需要这个数据的人都必须理解相关表的结构，并且知道如何创建查询和对表进行联结。为了检索其他产品（或多个产品）的相同数据，必须修改最后的WHERE子句。现在，假如可以把整个查询包装成一个名为productcustomers的虚拟表，则可以如下轻松地检索出相同的数据：第 22 章输入207156 第 22 章 使 用 视 图这就是视图的作用。 productcustomers是一个视图，作为视图，它不包含表中应该有的任何列或数据，它包含的是一个SQL查询（与上面用以正确联结表的相同的查询）。22.1.1 为什么使用视图我们已经看到了视图应用的一个例子。下面是视图的一些常见应用。? 重用SQL语句。? 简化复杂的SQL操作。在编写查询后，可以方便地重用它而不必知道它的基本查询细节。? 使用表的组成部分而不是整个表。? 保护数据。可以给用户授予表的特定部分的访问权限而不是整个表的访问权限。? 更改数据格式和表示。视图可返回与底层表的表示和格式不同的数据。在视图创建之后，可以用与表基本相同的方式利用它们。可以对视图执行SELECT操作，过滤和排序数据，将视图联结到其他视图或表，甚至能添加和更新数据（添加和更新数据存在某些限制。关于这个内容稍后还要做进一步的介绍）。重要的是知道视图仅仅是用来查看存储在别处的数据的一种设施。视图本身不包含数据，因此它们返回的数据是从其他表中检索出来的。在添加或更改这些表中的数据时，视图将返回改变过的数据。性能问题 因为视图不包含数据，所以每次使用视图时，都必须处理查询执行时所需的任一个检索。如果你用多个联结和过滤创建了复杂的视图或者嵌套了视图，可能会发现性能下降得很厉害。因此，在部署使用了大量视图的应用前，应该进行测试。输入20822.2 使用视图 15722.1.2 视图的规则和限制下面是关于视图创建和使用的一些最常见的规则和限制。? 与表一样，视图必须唯一命名（不能给视图取与别的视图或表相同的名字）。? 对于可以创建的视图数目没有限制。? 为了创建视图，必须具有足够的访问权限。这些限制通常由数据库管理人员授予。? 视图可以嵌套，即可以利用从其他视图中检索数据的查询来构造一个视图。? ORDER BY可以用在视图中，但如果从该视图检索数据SELECT中也含有ORDER BY，那么该视图中的ORDER BY将被覆盖。? 视图不能索引，也不能有关联的触发器或默认值。? 视图可以和表一起使用。例如，编写一条联结表和视图的SELECT语句。22.2 使用视图在理解什么是视图（以及管理它们的规则及约束）后，我们来看一下视图的创建。? 视图用CREATE VIEW语句来创建。? 使用SHOW CREATE VIEW viewname；来查看创建视图的语句。? 用DROP删除视图，其语法为DROP VIEW viewname;。? 更新视图时，可以先用DROP再用CREATE，也可以直接用CREATE ORREPLACE VIEW。如果要更新的视图不存在，则第2条更新语句会创建一个视图；如果要更新的视图存在，则第2条更新语句会替换原有视图。22.2.1 利用视图简化复杂的联结视图的最常见的应用之一是隐藏复杂的SQL，这通常都会涉及联结。请看下面的例子：209158 第 22 章 使 用 视 图这条语句创建一个名为productcustomers的视图， 它联结三个表，以返回已订购了任意产品的所有客户的列表。如果执行SELECT \* FROM productcustomers，将列出订购了任意产品的客户。为检索订购了产品TNT2的客户，可如下进行：这条语句通过WHERE子句从视图中检索特定数据。在MySQL处理此查询时，它将指定的WHERE子句添加到视图查询中的已有WHERE子句中，以便正确过滤数据。可以看出，视图极大地简化了复杂SQL语句的使用。利用视图，可一次性编写基础的SQL，然后根据需要多次使用。创建可重用的视图 创建不受特定数据限制的视图是一种好办法。例如，上面创建的视图返回生产所有产品的客户而不仅仅是生产TNT2的客户。扩展视图的范围不仅使得它能被重用，而且甚至更有用。这样做不需要创建和维护多个类似视图。22.2.2 用视图重新格式化检索出的数据如上所述，视图的另一常见用途是重新格式化检索出的数据。下面的SELECT语句（来自第10章）在单个组合计算列中返回供应商名和位置：分析输入输入输出分析21021122.2 使用视图 159现在，假如经常需要这个格式的结果。不必在每次需要时执行联结，创建一个视图，每次需要时使用它即可。为把此语句转换为视图，可按如下进行：这条语句使用与以前的SELECT语句相同的查询创建视图。为了检索出以创建所有邮件标签的数据，可如下进行：22.2.3 用视图过滤不想要的数据视 图 对 于 应 用 普 通 的 WHERE 子 句 也 很 有 用 。 例 如 ， 可 以 定 义customeremaillist视图，它过滤没有电子邮件地址的客户。为此目的，可使用下面的语句：输入分析输入输出输入输出212160 第 22 章 使 用 视 图显然，在发送电子邮件到邮件列表时，需要排除没有电子邮件地址的用户。这里的WHERE子句过滤了cust_email列中具有NULL值的那些行，使他们不被检索出来。现在，可以像使用其他表一样使用视图customeremaillist。WHERE子句与WHERE子句 如果从视图检索数据时使用了一条WHERE子句，则两组子句（一组在视图中，另一组是传递给视图的）将自动组合。22.2.4 使用视图与计算字段视图对于简化计算字段的使用特别有用。下面是第10章中介绍的一条SELECT语句。它检索某个特定订单中的物品，计算每种物品的总价格：为将其转换为一个视图，如下进行：输入分析输入输出输入输出21321422.2 使用视图 161为检索订单20005的详细内容（上面的输出），如下进行：可以看到，视图非常容易创建，而且很好使用。正确使用，视图可极大地简化复杂的数据处理。22.2.5 更新视图迄今为止的所有视图都是和SELECT语句使用的。然而，视图的数据能否更新？答案视情况而定。通常，视图是可更新的（即，可以对它们使用INSERT、 UPDATE和DELETE）。更新一个视图将更新其基表（可以回忆一下，视图本身没有数据）。如果你对视图增加或删除行，实际上是对其基表增加或删除行。但是，并非所有视图都是可更新的。基本上可以说，如果MySQL不能正确地确定被更新的基数据，则不允许更新（包括插入和删除）。这实际上意味着，如果视图定义中有以下操作，则不能进行视图的更新：? 分组（使用GROUP BY和HAVING）；? 联结；? 子查询；? 并；? 聚集函数（Min()、 Count()、 Sum()等）；输入输入输出215162 第 22 章 使 用 视 图? DISTINCT；? 导出（计算）列。换句话说，本章许多例子中的视图都是不可更新的。这听上去好像是一个严重的限制，但实际上不是，因为视图主要用于数据检索。可能的变动 上面列出的限制自MySQL 5以来是正确的。不过，未来的MySQL很可能会取消某些限制。将视图用于检索 一般，应该将视图用于检索（ SELECT语句）而不用于更新（ INSERT、 UPDATE和DELETE）。22.3 小结视图为虚拟的表。它们包含的不是数据而是根据需要检索数据的查询。视图提供了一种MySQL的SELECT语句层次的封装，可用来简化数据216 处理以及重新格式化基础数据或保护基础数据。