<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="sun-day-blog">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="sun-day-blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sun-day-blog">






  <link rel="canonical" href="http://yoursite.com/page/4/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>sun-day-blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">sun-day-blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">牛逼的人生不需要解释</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
</li>

      

      
    </ul>
  

  
    

    
    
      
      
    
      
      
    
    

  


  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/18-EMM-Procedure-6-Handover-without-TAU-Part-3-S1-Handover/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/18-EMM-Procedure-6-Handover-without-TAU-Part-3-S1-Handover/" itemprop="url">18-EMM Procedure 6. Handover without TAU - Part 3. S1 Handover</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:35:13+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6286" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6286</a></p>
<h1 id="I-Introduction"><a href="#I-Introduction" class="headerlink" title="I. Introduction"></a>I. Introduction</h1><p>之前的文档，我们讨论了X2切换，这篇文档我们关注在EPC干预下的S1切换。这里，我们假设source和target eNB连接在同一个MME/SGW，并且位于UE的TAI列表中的同一个TA下。第二章我们描述S1切换的概念，第三章我们详细描述S1切换，最后第四章我们总结在S1切换前后EPS实体信息的变化。</p>
<h1 id="II-Concept-of-S1-Handover"><a href="#II-Concept-of-S1-Handover" class="headerlink" title="II. Concept of S1 Handover"></a>II. Concept of S1 Handover</h1><h2 id="2-1-S1协议栈"><a href="#2-1-S1协议栈" class="headerlink" title="2.1 S1协议栈"></a>2.1 S1协议栈</h2><p>S1切换是通过S1接口source和target eNB之间执行的。在控制面eNB和MME通过S1AP信令通信，在用户面eNB和SGW通过GTP隧道通信。图1显示控制面和用户的S1接口上的协议栈。</p>
<p><img src="http://img.blog.csdn.net/20151010104116557" alt="这里写图片描述"></p>
<p>当安装一个新eNB时，就需要在eNB和MME之间执行S1 setup过程。eNB通过发送S1 setup request(eNB ID, eNB Name,TAC)给MME通知eNB配置信息。在MME中也会使用相应的<strong> MME容量参数</strong> 用于MME间的负载均衡。这个值被标记为权值，表示每一个MME处理UE连接的相对容量。eNB连接不止一个MME，当选择一个MME建立新的UE连接时使用这个值。eNB和EPC之间的UE连接如下：在控制面，eNB和MME之间每一个用户的信令都是通过S1AP信令连接提供的，并使用{eNB UES1AP ID, MME UE S1AP ID}标识，在用户面，eNB和SGW之间的每一个用户的S1承载都是通过GTP隧道来提供，并使用{DL S1 TEID (S1 eNB TEID), UL S1 TEID (S1 SGW TEID)}标识。</p>
<h2 id="2-2-和切换相关的S1AP过程和消息"><a href="#2-2-和切换相关的S1AP过程和消息" class="headerlink" title="2.2 和切换相关的S1AP过程和消息"></a>2.2 和切换相关的S1AP过程和消息</h2><p>表1和2是在GPP TS 36.413中S1AP的基本过程，包含non-UE和UE相关的过程。这个文档是和切换相关的，所以这里只讨论UE相关的过程。表1列出了S1切换相关的S1AP过程和他们相关的S1AP消息。</p>
<p><img src="http://img.blog.csdn.net/20151010104218858" alt="这里写图片描述"></p>
<p>列在上表中的这些S1AP消息在下面详细介绍：</p>
<ul>
<li><strong> Handover Required message</strong> : 这个消息用于切换准备阶段，由eNB发送给MME，包含target eNB的信息和source cell的无线资源。</li>
<li><strong> Handover Request message</strong> : 这个消息在切换准备阶段使用，由MME发送到target eNB，包含UE上下文信息。</li>
<li><strong> Handover Request Acknowledge message</strong> : 这个消息是在切换准备阶段使用的，它是当在target eNB中成功为UE分配资源时由target eNB发送给MME。target eNB分配DL S1 TEID供S1承载在切换后使用，并分配DL S1 TEID供S1承载(indirect tunnel)用于在切换时下行数据包的传送，包含在这个消息中转发他们。</li>
<li><strong> handover command message</strong> ：这个消息用于切换准备阶段，是由MME发送给source eNB。它包含了UE接入target eNB需要的信息（e.g. Target C-RNTI, Target eNB AS Security algorithm, DRB ID, etc.），并包含UL S1 TEID供SGW在切换时用于下行数据包传送。</li>
<li><strong> eNB status transfer message</strong> ：这个消息是在切换执行阶段使用，由source eNB发送给MME。指示target eNB应该从哪个数据包开始接收或者发送。</li>
<li><strong> MME Status Transfer message</strong> : 这个消息是在切换执行阶段使用，是由MME发送给target eNB。指示target eNB应该从哪个数据包开始接收或者发送。</li>
<li><strong> Handover Notify message</strong> : 这个消息在切换完成阶段使用，是由target eNB发送给MME，指示UE已经完成到target eNB的切换。</li>
<li><strong> UE Context Release Command message</strong> : 这个消息用在切换完成阶段，是由MME发送给source eNB请求UE上下文的释放。</li>
<li><strong> UE Context Release Complete message</strong> : 这个消息是在切换完成阶段使用，是由source eNB发送给MME指示UE上下文已经释放了。</li>
</ul>
<h2 id="2-3-S1-Handover-Procedure-at-a-Glance"><a href="#2-3-S1-Handover-Procedure-at-a-Glance" class="headerlink" title="2.3 S1 Handover Procedure at a Glance"></a>2.3 S1 Handover Procedure at a Glance</h2><p>像之前文档看到的，S1切换过程包括准备，执行，完成阶段。在我们详细介绍之前，我们简要预览一下S1切换过程。</p>
<p><img src="http://img.blog.csdn.net/20151010104310786" alt="这里写图片描述"></p>
<p>图2描述了在切换前/中/后需要的过程。方便起见，SGW和PGW被标记为SAE-GW，source和target eNB被标记为SeNB和TeNB。</p>
<p><strong> before S1 handover</strong><br>在上图中，UE是通过eNB A获得服务的。当UE检测到测量事件时，UE发送measurement report 给eNB A。</p>
<p><strong> S1 handover preparation</strong><br>source eNB基于自己保留的邻区列表信息和在measurement report 消息中包含的邻区信号强度信息选择target eNB作为切换目的地。接着，source eNB意识到通过X2连接切换到target eNB是不可能的，所以决定执行S1切换，并通过MME执行。所有的eNB都是通过S1AP信令和MME通信。这时，target eNB提前分配资源来确保source eNB提供的服务在target eNB同样可用。MME提供给source eNB所有的UE接入target cell需要的所有信息。</p>
<p>期间，target eNB和SGW分配创建indirect tunnel需要的资源，通过这个indirect tunnel，到达source eNB的下行数据转发给SGW，最终发送给target eNB。如下所示：</p>
<ul>
<li>source eNB发送target eNB所需要的信息给MME， 包含在handover required消息中。（1）</li>
<li>MME发送handover request消息给target eNB，包含target eNB需要的AS安全信息来创建AS安全基础秘钥和UE上下文。</li>
<li>target eNB（2）<ul>
<li>使用从MME获得的S1 S-GW TEID建立上行S1承载，通过这个承载在切换后可以转发上行数据包。并为下行S1承载分配S1 target eNB TEID。（3）</li>
<li>为连接SGW和target eNB的indirect tunnel分配S1 target eNB TEID。</li>
<li>配置handover command消息，包含UE接入target cell所需要的所有的信息。</li>
<li>把这些信息包含在handover request ack发送给MME。（4）</li>
</ul>
</li>
<li>MME一旦接收到这个消息，在create indirect data forwarding tunnel request消息中包含target eNB为indirect tunnel分配的S1 target eNB TEID，并把这个消息发送给SGW。（5）</li>
<li>SGW<ul>
<li>创建indirect tunnel连接target eNB（6）</li>
<li>分配S1 S-GW TEID用于source eNB和SGW之间的indirect tunnel的创建，并通过Create Indirect Data Forwarding Tunnel Response消息发送给MME。</li>
</ul>
</li>
<li>MME包含i）SGW为indirect tunnel分配的S1 S-GW TEID，ii）包含UE接入target cell所需的信息，包含在handover command消息发送给source eNB。</li>
<li>接着，source eNB创建连接SGW的indirect tunnel。</li>
</ul>
<p>通过第8和第6步，连接source eNB，SGW，target eNB三个实体的indirect tunnel创建成功了。</p>
<p><strong> S1 handover execution</strong><br>现在两个eNB准备好切换了，是时候命令UE执行了。</p>
<ul>
<li>source eNB<ul>
<li>通过发送handover command消息包含UE接入target cell需要的信息命令UE执行切换到target cell（1）</li>
<li>发送eNB status transfer消息通知MME，eNB应该从哪个上行/下行数据包开始接收/发送。（2）</li>
<li>通过indirect tunnel发送从SGW接收到的下行数据包给target eNB。（4）</li>
</ul>
</li>
<li>MME通过发送MME status transfer消息通知target eNB，它应该从哪个UL/DL数据包开始发送/接收。（3）</li>
<li>UE从source eNB断开，接入到target eNB。（5）</li>
<li>一旦UE成功接入target eNB，UE就立即有能力发送或接收数据包了。（6）</li>
</ul>
<p><strong> S1 handover completion</strong><br>因为MME已经知道UE执行切换，不像X2切换，target eNB不需要MME进行路径修改。一旦UE连接到target eNB，target eNB给MME发送handover notify消息指示UE已经完成切换。</p>
<ul>
<li>一旦UE连接，target eNB给MME发送handover notify通知切换完成（1）</li>
<li>接着MME请求SGW做S1承载修改。SGW修改下行S1承载路径连接target eNB。（2）（3）</li>
<li><p>SGW改变承载路径：如下</p>
<ul>
<li>SGW通过连接source eNB的下行S1承载发送end marker（EM）停止下行数据包传输。</li>
<li>接着SGW创建连接target eNB的下行S1承载，并恢复下行数据包传输给target eNB。</li>
</ul>
</li>
<li><p>target eNB给UE发送下行数据包如下：</p>
<ul>
<li>target eNB在EM标记数据包到达之前通过indirect tunnel发送下行数据包</li>
<li>一旦EM标记数据包到达，target eNB通过新路径给UE发送数据包。</li>
</ul>
</li>
<li><p>MME：</p>
<ul>
<li>MME通过发送UE context release command消息请求source eNB释放S1承载资源和UE上下文。（4）</li>
<li>MME通过发送delete indirect data forwarding tunnel request消息通过SGW释放和indirect tunnel相关的资源。（5）</li>
</ul>
</li>
</ul>
<p><strong> after S1 handover</strong><br>UE现在可以通过eNB B提供服务。</p>
<h2 id="2-4-在S1切换前后UE状态和连接信息"><a href="#2-4-在S1切换前后UE状态和连接信息" class="headerlink" title="2.4 在S1切换前后UE状态和连接信息"></a>2.4 在S1切换前后UE状态和连接信息</h2><p>图3描述了在S1切换前后控制面用户面的连接建立情况，和UE/MME的状态。</p>
<p><strong> before S1 handover</strong><br>UE在EMM-REgistered和ECM/RRC-connected状态，并保持着E-UTRAN和EPC分配的所有资源。</p>
<p><strong> during S1 handover</strong><br>即使在切换阶段，NAS层的UE状态一直保持不变。source eNB和target eNB都通过S1信令连接到MME上。他们也通过indirect tunnel连接到SGW上。在图3中，step-2展示了在切换执行阶段切换中断时的连接和状态。在这个阶段，没有激活的无线连接，但是UE仍保持连接状态。</p>
<p><strong> after S1 handover</strong><br>UE保持在EMM-REgistered和ECM/RRC-connected状态。在用户面，E_RAB（DRB+S1承载）转到连接新eNB的路径上，在控制面建立了新的RRC连接。</p>
<p><img src="http://img.blog.csdn.net/20151010104408319" alt="这里写图片描述"></p>
<h1 id="III-Procedure-of-S1-Handover"><a href="#III-Procedure-of-S1-Handover" class="headerlink" title="III. Procedure of S1 Handover"></a>III. Procedure of S1 Handover</h1><p>现在我们详细介绍S1切换过程。图4描述了在S1切换之前的EPS承载和信令连接，并包括S1切换准备阶段详细过程。<br><img src="http://img.blog.csdn.net/20151010104449020" alt="这里写图片描述"></p>
<p><strong> before handover</strong><br><strong> 1）【UE-&gt;eNB】measurement report</strong><br>一旦测量事件触发，UE测量邻区的信号强度，并给服务小区发送measurement report 消息。</p>
<p><strong> handover preparation</strong><br><strong> 2）【source eNB】handover decision</strong><br>source eNB根据measurement report消息包含的信息和source eNB自己保留的邻区列表信息中选择target eNB。并且发现在两个eNB之间没有有效X2连接可用，source eNB决定执行S1切换。</p>
<p><strong> 3）【source eNB-&gt;MME】 requesting handover</strong><br>source eNB发送handover required消息给MME，请求切换到target eNB。这个消息包含如下：<br>Handover Required (Handover Type, Target eNB ID, Source to Target Transparent Container)</p>
<ul>
<li>Handover Required (Handover Type, Target eNB ID, Source to Target Transparent Container)</li>
<li>Target eNB ID: 包含Target Global eNB ID and Selected TAI information</li>
<li>Source to Target Transparent Container: is used when forwarding the radio-related information of the source cell to the target cell transparently through EPC (MME)</li>
</ul>
<p><strong> 4) [MME] 产生安全上下文转发给target eNB</strong><br>MME生成安全上下文{NCC,NH}, target eNB可用产生AS安全基础秘钥。NCC从初始NCC值开始加1，NH是从初始NH值和Kasme值产生的。<br><img src="http://img.blog.csdn.net/20151013092154440" alt="这里写图片描述"></p>
<p><strong> 5）【target eNB &lt;-MME】请求target eNB切换</strong><br>MME给target eNB发送handover request消息，代表 source eNB请求切换。这个消息如下：<br>Handover Request (UE-AMBR, E-RAB to be setup (E-RAB ID, QCI, ARP, S1 S-GW TEID), Source to Target Transparent Container, UE Security Capability, Security Context)</p>
<ul>
<li>Handover Request (UE-AMBR, E-RAB to be setup (E-RAB ID, QCI, ARP, S1 S-GW TEID), Source to TargetTransparent Container, UE Security Capability, Security Context)</li>
<li>E-RAB to be setup: UE’s E-RAB information stored at Source eNB. Includes E-RAB ID, QoS parameters, UL S1 bearer information</li>
<li>Source to Target Transparent Container: is used when forwarding the radio-related information of the source cell (e.g. UE radio access capability, RRC configuration Info, etc.) to the target cell transparently through EPC (MME).</li>
<li>UE Security Capability: security algorithms supported by UE (encryption and integrity algorithm)</li>
<li>Security Context: includes {NCC, NH} to be used when Target eNB derives the AS Security base key, KeNB*</li>
</ul>
<p><strong> 6) [Target eNB] 准备S1 handover</strong><br>一旦接收到handover request消息，target eNB开始准备切换为UE提供无缝服务<br><strong> i)新的S1承载资源分配</strong> ：target eNB基于要建立的E-RAB信息，检查source eNB提供的QoS是否在target eNB中可用。如果可用，target eNB使用存储在source eNB中的上行S1承载信息（S1 SGW TEID）建立上行S1承载连接SGW。接着分配S1 target eNB TEID准备下行S1承载。</p>
<p><strong> ii）indirect tunnel资源分配</strong> ：在UE执行S1切换时，应该有一个从source eNB到target eNB的indirect tunnel。所以，target eNB分配S1 target eNB TEID，SGW可以建立indirect tunnel连接target eNB。</p>
<p><strong> iii）为UE在无线链路上分配资源</strong> ：基于E-RAB的QoS信息，target eNB为UE在无线链路上保留RRC资源，并分配C-RNTI。</p>
<p><strong> iv）Kenb*产生</strong> ：使用从MME中接收到的安全上下文信息（NCC1，NH1）来产生Kenb<em>，接着获得AS安全秘钥(KRRCint, KRRCenc, KUpenc)。接着，当UE连接到target eNB是，UE和target eNB可以使用这些秘钥来安全的通信。图5显示了Kenb </em>是怎么产生的。我们可以看到Kenb *从NH1，PCI，频点生成。<br><img src="http://img.blog.csdn.net/20151010104536396" alt="tunnel connecting to the target eNB."><br><strong> 7）【target eNB-&gt;MME】通知MME准备完毕</strong><br>target eNB给MME发送handover request ack消息，消息中包含了step-6中的所有资源。这些消息如下所示：<br>Handover Request Ack (E-RAB Admitted(E-RAB ID, S1 Target eNB TEID, DL S1 Target eNB TEID), Handover Command (Target C-RNTI, Target DRB ID, AS Security Algorithm of Target eNB))</p>
<ul>
<li><p>E-RAB Admitted</p>
<ul>
<li><strong> E-RAB ID</strong> : E-RAB ID allocated by the target eNB</li>
<li><strong> S1 Target eNB TEID</strong> : DL S1 TEID that the target eNB allocated to S-GW for establishment of S1 bearer connecting to itself.</li>
<li><strong> DL S1 Target eNB TEID</strong> : DL S1 TEID that the target eNB allocated for establishment of an indirect tunnel for handover through which to deliver DL packets.</li>
</ul>
</li>
<li><p><strong> Handover Command:</strong>  Transparent Container, delivered by the target eNB to the source eNB, that contains the radio information of the target cell that UE needs to access the target eNB.</p>
<ul>
<li>Target C-RNTI: C-RNTI allocated by the target cell to identify UE.</li>
<li>Target DRB ID: ID of DRB that the target eNB set to deliver user packets over the radio link.</li>
<li>Target DRB ID: ID of DRB that the target eNB set to deliver user packets over the radio link.</li>
</ul>
</li>
</ul>
<p><strong> 8）【MME-&gt;SGW】请求S1承载创建用于下行数据包传输</strong><br>MME给SGW发送Create Indirect Data Forwarding Tunnel Request消息，请求创建indirect tunnel用于交付下行数据包。这个消息包括GTP TEID（S1 Target eNB TEID，target eNB分配的）</p>
<p><strong> 9）【MME&lt;-SGW】通知MME S1承载创建完成</strong><br>SGW一旦接收到Create Indirect Data Forwarding Tunnel Request消息，创建一个连接target eNB的indirect tunnel。接着分配S1 SGW TEID，通过Create Indirect Data Forwarding Tunnel Response消息转发给MME，source eNB可以使用这个TEID穿件indirect tunnel连接SGW。</p>
<p><strong> 10）【source eNB&lt;-MME】通知完成切换</strong><br>MME发送给source eNB handover command消息包含i)S1 SGW TEID（在step-9从SGW接收到）ii）包含包含handover command消息（在step-7从target eNB接收到的）<br>source eNB从handover command消息中知道target eNB和EPC已经准备UE切换了。</p>
<p><strong> handover execution</strong><br>图6描述了S1切换的执行阶段。<br><img src="http://img.blog.csdn.net/20151010104638181" alt="这里写图片描述"></p>
<p><strong> 11）【UE&lt;-source eNB】命令UE执行切换</strong><br>一旦source eNB准备好切换，source eNB发送handover command消息命令UE执行切换。这个消息是包含在RRC connection reconfiguration消息中的。</p>
<p><strong> 12）【UE】执行切换</strong><br>一旦UE从handover command消息中获得C-RNTI和DRB ID，并从source eNB detach。现在UE和source eNB之间的所有的数据包交换都停止了，切换中断时间开始了。</p>
<p><strong> 13）【UE】AS安全建立</strong><br>UE产生AS安全秘钥用于target eNB的无线链路。首先产生Kenb*，接着使用target eNB选择的AS安全算法产生AS安全秘钥 (KRRCint, KRRCenc, KUPenc)。<br><strong> 14）~15）【source eNB-&gt;MME.MME-&gt;target eNB】通知从哪个数据包开始发送/接收</strong><br>source eNB发送eNB status transfer 消息，包含DL count和UL count给MME。接着MME通过MME status transfer消息包含相同的信息给target eNB。这是为了让target eNB知道从哪个数据包开始发送/接收数据包。这里这个count值是PDCP PDU计数，每一个count是32bit值，包含HFN超帧号和PDCP序列号SN。这个消息如下：<br>eNB Status Transfer (DL Count, UL Count)<br> DL Count: Count of the first packet to send to the UE<br> UL Count: Count of the first packet to receive from the UE<br>在发送eNB status transfer消息之后，source eNB开始通过indirect tunnel转发从SGW到达的下行数据包给target eNB。target eNB缓存这些数据包，知道UE成功接入到target eNB。<br><strong> 16）-18）【UE，target eNB】UE接入到target eNB</strong><br>16）UE检测到target eNB的同步信号并执行同步到target eNB。一旦同步完成，UE发起非竞争的随即接入。17）target eNB给UE发送时间偏移信息和上行授权。18）UE给target eNB发送handover confirm消息包含在RRC connection reconfiguration complete消息中。<br>现在UE可以从target eNb接收或发送数据包了。切换中断时间结束。<br><strong> 19）【UE~target eNB】无线链路上的安全通信</strong><br>UE和target eNB之间的所有的RRC信令消息和用户数据包都是使用AS安全秘钥安全传输的。rrc信令消息是完整性保护和加密的，用户数据是加密的。<br><strong> 20）【target eNB】恢复下行数据包交付给UE</strong><br>随着UE成功连接到target eNB，target eNB通过下面的路径恢复发送缓冲的下行数据包给UE。<br>S5承载( PGW到SGW)—-S1承载（SGW到source eNB）—–S1承载（source eNB到SGW）—-S1承载（SGW到target eNB）—DRB（target eNB到UE）<br>对于UE发送的数据包，target eNB检查是否以正确的顺序接收到上行数据包，接着通过下面的路径转发给SGW。<br>DRB（UE到target eNB）—S1承载（target eNB到SGW）—S5承载（SGW到PGW）<br><strong> handover completion</strong><br>图7描述了S1切换结束阶段的过程。<br><img src="http://img.blog.csdn.net/20151010104733471" alt="这里写图片描述"><br><strong> 21）【target eNB-&gt;MME】请求EPS承载路径转换</strong><br>一旦UE成功接入，target eNB通过发送handover notify消息给MME通知UE已经成功完成了S1切换，这个消息中包含ECGI和TAI。<br><strong> 22）~27）修改EPS承载</strong><br>MME转发由target eNB分配的S1 target eNB TEID给SGW（通过发送modify bearer request消息）。通过这种方式请求SGW修改承载路径。接着SGW建立下行S1承载连接target eNB。一些SGW，根据UE初始附着时的选项设置，需要报告UE的服务小区是否发生变化。就需要SGW发送modify bearer request消息给PGW（PGW报告给PCRF），根据EPS会话修改过程，表示UE服务小区发生变化了。<br><strong> 28）~29）【SGW】修改S1承载路径</strong><br>SGW转换下行数据包转发路径为连接target eNB的下行S1承载。首先SGW发送end marker（EM）来指示发送给source eNB的最后一个数据包。接着它通过连接target eNB的S1承载来发送下行数据包。<br><strong> 30）【target eNB】数据包重新排序</strong><br>现在，target eNB接收到从source eNB转发过来的下行数据包，和通过新修改的路径的下行数据包。所以应该以正确的顺序交付给UE。首先target eNB转发从indirect tunnel接收到的数据包，接着当EM到达时，就是知道从indirect tunnel的最后一个数据包，接着发送从新修改的路径上接收到的下行数据包给UE。<br><strong> 31）~32）【source eNB<->MME】释放存储在source eNB中的UE上下文和S1资源</-></strong><br>MME通知source eNB，source eNB可以释放indirect tunnel和S1资源，以及UE上下文了（通过发送UE context release command消息）。<br><strong> 33）~34）【MME<->SGW】MME给SGW发送delete indirect data forwarding tunnel</-></strong><br>request消息请求释放indirect tunnel。一旦接收到这个请求，SGW释放indirect tunnel，并发送delete indirect data forwarding tunnel response消息通知MME释放完成。</p>
<h1 id="IV-EPS-entity-information：before-after-S1-handover"><a href="#IV-EPS-entity-information：before-after-S1-handover" class="headerlink" title="IV. EPS entity information：before/after S1 handover"></a>IV. EPS entity information：before/after S1 handover</h1><p>在intra-LTE环境中，在S1切换前后存储在EPS实体中的信息和X2相同、</p>
<ul>
<li>切换相关的As安全上下文会根据切换的类型不同俄日变化（S1 or X2）。切换安全在本篇文档范围之外。</li>
<li>在切换过程中，EPS实体中存储的信息十分相同，但是也会根据切换类型而不同。</li>
</ul>
<h1 id="V-closing"><a href="#V-closing" class="headerlink" title="V. closing"></a>V. closing</h1><p>目前为止，我们讨论了在SGW和MME都不发生变化时的S1切换过程。不想X2切换，在S1切换中，EPS知道UE的切换。EPC从切换准备阶段参与到切换过程。它和source eNB，target eNb协作共同完成切换。<br>在EMM case-6我们讨论了LTE 切换。接下来对我们将讨论小区重选。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “LTE EMM Procedure 6 – Part 2. X2 Handover”, March 2014, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6257" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6257</a><br>[2] 3GPP TS 36.413, “Evolved Universal Terrestrial Radio Access Network (E-UTRAN); S1 Application Protocol (S1AP)”<br>[3] Netmanias Technical Document, “LTE EMM Procedure 6 – Part 1. Overview of LTE Handover”, March 2014, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6224" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6224</a><br>[4] 3GPP TS 36.331, “Evolved Universal Terrestrial Radio Access (E-UTRA); Radio Resource Control (RRC); Protocol specification”<br>[5] Netmanias Technical Document, “LTE Security II: NAS and AS Security”, August 2013, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903</a><br>[6] Netmanias Technical Document, “Eleven EMM Cases in an EMM Scenario”, October 2013, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002</a><br>[7] NMC Consulting Group Confidential Internal Report, “E2E LTE Network Design”, August 2010</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/17-EMM-Procedure-6-Handover-without-TAU-Part-2-X2-Handover/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/17-EMM-Procedure-6-Handover-without-TAU-Part-2-X2-Handover/" itemprop="url">17-EMM Procedure 6. Handover without TAU - Part 2. X2 Handover</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:34:57+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6257" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6257</a></p>
<h1 id="I-Introduction"><a href="#I-Introduction" class="headerlink" title="I. Introduction"></a>I. Introduction</h1><p>在前一篇文档中我们讨论了LTE切换相关的过程，并学习了LTE切换是一个 UEassisted / network - controlled 的过程，即UE报告，eNB决定。这篇文档将讨论X2切换。所以我们假设源和目的eNB都连接到同一个MME/SGW，并且位于同一个TA，也就是在UE的TAI列表中。第二章将讨论X2切换的概念，第三章详细介绍X2切换的过程，最后第四章将总结在X2切换前后EPS实体的信息是怎么变化的。</p>
<h1 id="II-Concept-of-X2-Handover"><a href="#II-Concept-of-X2-Handover" class="headerlink" title="II. Concept of X2 Handover"></a>II. Concept of X2 Handover</h1><h2 id="2-1-X2-Protocol-Stacks"><a href="#2-1-X2-Protocol-Stacks" class="headerlink" title="2.1 X2 Protocol Stacks"></a>2.1 X2 Protocol Stacks</h2><p>X2切换是通过X2接口在源eNB和目的eNB之间执行的。在一个LTE网络中，两个eNB可以通过X2接口直接通信，这不同于在2/3G网络的情况。在2/3G网络中，eNB获得邻eNB状态的唯一的方法就是通过数据核心节点的控制。但是在LTE网络，允许eNB直接通过X2接口来交换状态信息，并在没有EPC节点的介入下来独立的执行切换。图1展示了控制面和用户面X2接口上的协议栈。</p>
<p><img src="http://img.blog.csdn.net/20151009084518731" alt="这里写图片描述"></p>
<p>在控制面，两个eNB通过SCTP数据流控制传输协议提供给多个用户X2AP X2应用层协议信令。在X2AP层，使用eNB UE X2AP ID (Old eNB UE X2AP ID, New eNB UE X2AP ID)来标识用户。<br>在数据面，两个eNB通过GPRS隧道协议GTP协议连接。为每一个用户产生一个独一无二的GTP隧道，并且每一个隧道被分配的TEID标识。</p>
<h2 id="2-2-X2AP功能"><a href="#2-2-X2AP功能" class="headerlink" title="2.2 X2AP功能"></a>2.2 X2AP功能</h2><p>表1列出了通过X2AP信令执行的功能，并且和每一个功能相关的基本过程。如下所示，X2AP信令信息可以粗略地分为两种，一种是和负载/接口相关（例如，负载管理），另一种是和切换相关（例如，移动性管理，移动参数管理，移动鲁棒性优化）。</p>
<p><img src="http://img.blog.csdn.net/20151009084617310" alt="这里写图片描述"></p>
<p>对比2/3G网络，像LTE宽带网络具有少的小区覆盖，但是有很多基站来覆盖。所以，像2/3G那样传统的配置和管理网络方式将不再有效。为了处理这个问题，在LTE网络中，定义了X2AP协议来提供自组网SON功能。这就允许eNB可以连接到邻eNB，获取他们的状态信息，并使用获取的信息自动的配置和优化参数。在表1列出的X2AP功能，这些和SON相关的如下：</p>
<p><strong>Load Management</strong>: 通过在两个eNB之间交换负载和接口信息来增强性能干涉。<br><strong>eNB Configuration Update</strong>: 执行自动eNB配置<br><strong>Mobility Parameters Management</strong>: 在eNB之间协商切换触发设置信息，并使用这些信息来切换优化<br><strong>Mobility Robustness Optimization</strong>: 对切换失败事件提供信息<br><strong>Energy Saving</strong>: 通过交换交换小区的激活或者去激活来帮助eNB减少能量消耗</p>
<h2 id="2-3-和移动向管理相关的X2消息"><a href="#2-3-和移动向管理相关的X2消息" class="headerlink" title="2.3 和移动向管理相关的X2消息"></a>2.3 和移动向管理相关的X2消息</h2><p>表2显示了用于移动性管理功能的消息，和切换相关的将会在第三章讨论。我可以看出在切换准备阶段需要来自目标eNB的响应消息。</p>
<p><strong>Handover Request message</strong>: 这个小区在切换准备阶段使用。它由源eNB发送给目的eNB，包含用户的UE上下文。<br><strong>Handover Request Acknowledge message</strong>: 这个消息在切换准备阶段使用，在目的eNB成功完成资源分配之后由目的eNB发送给源eNB。<br><strong>Handover Preparation Failure message</strong>: 这个消息在切换准备阶段使用，在目的eNB分配资源失败时由目的eNB发送给源eNB。<br><strong>SN Status Transfer message</strong>: 这个消息在切换执行阶段使用，它由源eNB发送给目的eNB来指示从哪一个数据包开始应该接收或者发送。<br><strong>UE Context Release message</strong>: 这个消息在切换完成阶段使用，由目的eNB发送给源eNB，来请求UE上下文的释放。<br><strong>Handover Cancel message</strong>: 这个消息在切换准备阶段使用，当需要删除一个正在准备的切换时由源eNB发送给目的eNB。</p>
<p><img src="http://img.blog.csdn.net/20151009084702259" alt="这里写图片描述"></p>
<h2 id="2-4-简要X2切换过程"><a href="#2-4-简要X2切换过程" class="headerlink" title="2.4 简要X2切换过程"></a>2.4 简要X2切换过程</h2><p>如前一个文档所述，X2切换过程包括准备，执行，完成阶段。在我们深入讨论之前，我们将简要预览一下X2切花过程。如2描述了在X2切换前，中，后需要的过程。为了方面SGW和PGW被标记为SAE-GW，源和目的eNB被标记为SeNB和TeNB。</p>
<p><img src="http://img.blog.csdn.net/20151009084735359" alt="这里写图片描述"></p>
<p><strong>Before X2 Handover</strong><br>在上图中，UE是由eNB A服务，当UE检测到一个测量事件，UE给eNB A发送测量报告消息。</p>
<p><strong>X2 Handover Preparation</strong><br>源eNB基于自己保存的邻区列表信息和包含在测量报告消息中的邻区信号强度信息来选择目的eNB切换。接着，通过X2信令和目的eNB准备X2切换。这时，目的eNB提前分配资源，使得在源eNB用户可用的服务现在在目的eNB也可用了。为了切换更快的切换，目的eNB发送给源eNB 目的eNB需要的所有UE信息，同样也把这些信息发送给UE，来发起切换执行阶段。目的eNB分配的资源如下：</p>
<ul>
<li>当源eNB给目的eNB发送handover request消息包含用户UE上下文（1）。</li>
<li>目的eNB：<ul>
<li>获取S1承载信息(S1 S-GW TEID)来建立上行S1承载传输上行数据包（2）.</li>
<li>为X2传输协议（GTP-U）分配TEID，用于在UE试图接入目的eNB时接收下行数据。</li>
<li>分配DRB资源和C-RNTI供UE在目的小区中使用。</li>
<li>发送handover request ack消息给源eNB（3）。</li>
</ul>
</li>
<li>一旦接受到这个消息，源eNB建立X2传输承载用于发送下行数据包（4）。</li>
</ul>
<p><strong>X2 Handover Execution</strong><br>一旦在两个eNB之间切换准备完成，可以开始执行切换了。</p>
<ul>
<li>源eNB<ul>
<li>通过发送handover command消息（包含接入目的小区需要的所有信息）指示UE来执行切换到目的小区。（1）</li>
<li>通过发送给目的eNB一个SN status transfer消息通知目的eNB当和UE通信时哪一个UL/DL数据包需要接收或者发送（2）</li>
<li>通过X2传输承载转发从SGW接收到的下行数据包给目的eNB（3）</li>
</ul>
</li>
<li>UE从源eNB去附着，并接入到目的eNB（4）.</li>
<li>一旦UE成功接入，目的eNB有能力发送和接收数据包了（5）。</li>
</ul>
<p><strong>X2 Handover Completion</strong><br>到目前为止，从源eNB决定执行切换开始，在切换执行阶段到UE最终连接到目的eNB，之间执行的所有过程都没有切换相关的信息报告给EPC（MME）。现在切换完成了，目的eNB通知EPC：</p>
<ul>
<li>一旦UE接入完成，目的eNB通知EPC，并发送path switch request消息给MME，通知EPC承载路径可以修改了。（1）</li>
<li>当接收到这个消息，MME觉察到UE新的服务小区，接着需求请求SGW修改S1承载（2）。</li>
<li>一旦请求，SGW建立下行S1承载(S1 Target eNB TEID)连接到目的eNB。接着SGW停止发送下行数据包到源eNB，并通过新建立的下行承载开始向目的eNB发送下行数据包。（3）</li>
<li>MME通知目的eNB，下行S1承载路径已经修改完成（4）。</li>
<li>目的eNB发送给源eNB一个UE Context Release消息，允许源eNB释放UE上下文。（5）</li>
</ul>
<p><strong>After X2 Handover</strong><br>UE开始通过eNB B获得服务。</p>
<h2 id="2-5-X2切换前后UE状态和连接信息"><a href="#2-5-X2切换前后UE状态和连接信息" class="headerlink" title="2.5 X2切换前后UE状态和连接信息"></a>2.5 X2切换前后UE状态和连接信息</h2><p>图3描述了在用户面控制面建立的连接，和UE、MME状态<br><strong>Before X2 Handover</strong><br>UE处于EMM-Registered and ECM/RRC-Connected状态并保持E-UTRAN和EPC分配的资源。<br><strong>During X2 Handover</strong><br>即使在切换状态，NAS层UE状态保持不变，X2承载和X2信令连接通过X2接口建立。在图3中，第2步展示了在切换执行阶段当切换中断时的连接和状态。这时候，没有无线连接处于激活状态，但是UE一直保持connected。<br><strong>After X2 Handover</strong><br>UE保持在EMM-Registered and ECM/RRC-Connected状态。用户面的E-RAB(DRB+S1承载)路径转移到新的eNB上，控制面的新RRc连接和S1信令连接(eNB(B) S1AP UE ID)也建立起来了。</p>
<p><img src="http://img.blog.csdn.net/20151009084840231" alt="这里写图片描述"></p>
<h1 id="III-Procedure-of-X2-Handover"><a href="#III-Procedure-of-X2-Handover" class="headerlink" title="III. Procedure of X2 Handover"></a>III. Procedure of X2 Handover</h1><p>现在我们来详细讨论X2切换过程。图4描述了在X2切换之前的EPS承载和信令连接，和详细的X2切换准备过程。</p>
<p><img src="http://img.blog.csdn.net/20151009084918089" alt="这里写图片描述"></p>
<p><strong>Before Handover</strong><br>1) [UE -&gt; eNB] Measurement Report<br>随着测量事件触发，UE测量邻区的信号强度，并发送measurement report消息给响应的eNB。</p>
<p><strong>Handover Preparation</strong><br>2) [Source eNB] Handover Decision<br>源eNB基于measurement report消息包含的信息和自己保存的邻区列表信息选择目标eNB。在实际切换中，有不止一个目标eNB选择或者不是UE报告的邻区被选择为目标小区。但是，我假设只有一个eNB包含在measurement report消息里面，这个eNB被选择为目标eNB。</p>
<p>3) [Source eNB] Deriving the AS Security Base Key (KeNB<em>) to be Used by the Target eNB<br>当切换发生时，UE的服务eNB发生转换。在转换期间，RRC信令消息和用户数据包不得不无缝的和安全的传送。在无线连接上，是AS安全秘钥确保这些数据的安全传输。AS安全秘钥是从KeNB（AS安全基础秘钥）衍生的。KeNB是在用户鉴权后从KASME派生的，由MME发送给eNB。但是，因为X2切换是在没有EPC干预下在两个eNB之间执行的，目的eNB不能从MME中获得KeNB</em>（KeNB被目的eNB使用）。所以，源eNB生成这个秘钥然后发送给目的eNB。这样，一旦源eNB决定执行切换，它会首先产生KeNB <em>，如图5所示。KeNB </em>从KeNB/目标小区PCI和频率（EARFCN-DL）中派生。<br><img src="http://img.blog.csdn.net/20151009084958710" alt="这里写图片描述"><br>4) [Source eNB -&gt; Target eNB] 请求X2切换<br>源eNB给目的eNB发送handover request消息请求切换。通过这个消息，传输存储的UE上下文信息和UE历史信息（UE连接目的小区优先于最后切换到的目标小区）。这个信息包括如下：<br><strong>Handover Request</strong> (Target Cell ID, UE Context Info(UE-AMBR, UE Security Capability, KeNB*, E-RAB to be setup (E-RAB ID, QCI, ARP, S1 S-GW TEID), RRC Context), UE History Info)</p>
<ul>
<li>Target Cell ID: the target cell’s ECGI</li>
<li>UE Context Info: UE context stored at the source eNB<ul>
<li>UE-AMBR: provided by HSS, but can be modified by MME. This value can be set for eNB, and used to control the aggregated MBR value of non-GBR bearers.</li>
<li>UE Security Capability: security algorithms supported by UE (encryption and integrity algorithm)</li>
<li>KeNB*: AS security base key generated by the source eNB for the target eNB’s use, i.e. KeNB to be used by the target eNB</li>
<li>E-RAB to be setup: UE’s E-RAB information stored at the source eNB</li>
</ul>
</li>
<li>UE History Info: information about the cells that UE has accessed while staying Active, including each cell’s ECGI, type and the duration of UE’s stay in the cell.</li>
</ul>
<p>5) [Target eNB] 准备X2切换<br>一旦接收到handover request消息，target eNB开始切换准备为UE提供无缝的服务。<br>(i) 首先，target eNB从source eNB接收的KeNB*生成AS安全秘钥(KRRCint, KRRCenc, KUPenc)。使用这些秘钥，target eNB可以和UE安全的通信。<br>(ii) 接着，target eNB基于要建立的E-RAB信息检查source eNB提供的相同的QoS是否在target eNB中可用。如果可用，target eNB通过存储在source eNB的上行S1承载信息(S1 S-GW TEID)建立上行S1承载连接SGW。<br>(iii) 接着，基于E-RAB QoS信息，target eNB在无线链路上为UE保留RRc资源，并分配C-RNTI。<br>(iv) 当UE执行切换时，到达source eNB的下行数据包需要转发给target eNB。为了实现这个，target eNB分配X2 Target eNB TEID (DL TEID of X2 GTP tunnel) ，source eNB可以建立X2传输承载（GTP隧道）。<br>6) [Source eNB &lt;- Target eNB] 给source eNB通知切换准备完成<br>target eNB发送handover request ack消息包含在step-5准备的所有资源。这些信息如下：<br><strong>Handover Request Ack</strong> (E-RAB Admitted (E-RAB ID, Target eNB TEID), Handover Command (Target CRNTI, Target DRB ID, AS Security Algorithm of Target eNB))</p>
<ul>
<li>E-RAB Admitted 12: includes i) E-RAB ID allocated by the target eNB, and ii) TEID information of X2 transport bearer through which E-RAB packets are to be forwarded to the target eNB.</li>
<li>Handover Command: Transparent Container, delivered by the target eNB to the source eNB, that contains information that UE needs to access the target eNB<ul>
<li>Target C-RNTI: C-RNTI allocated by the target cell to identify UE</li>
<li>Target DRB ID: ID of DRB that the target eNB set to deliver user packets over the radio link</li>
</ul>
</li>
<li>AS Security Algorithm of Target eNB: AS Security algorithm supported by the target eNB</li>
</ul>
<p>7) [Source eNB] 为下行数据包交付建立X2传输承载<br>一旦接收到handover request ack消息，source eNB知道target eNB可以服务UE了。接着使用X2  target eNB TEID，source eNB开始建立X2传输承载，在切换执行阶段可以使用这个承载把下行数据包转发给target eNB。</p>
<p><strong>Handover Execution</strong><br>图6显示了X2执行阶段的详细过程。</p>
<p><img src="http://img.blog.csdn.net/20151009085052813" alt="这里写图片描述"></p>
<p>8) [UE &lt;- Source eNB] 命令切换<br>一旦source eNB和target eNB完成切换准备，source eNB发送handover command消息命令UE执行切换。</p>
<p>9) [UE] 执行切换<br>UE从handover command消息中获得C-RNTI和DRB ID用于target cell，并从source eNB上detach。现在UE和source eNB之间的所有数据包都中断了，切换中断时间周期开始。</p>
<p>10) [UE] AS安全建立<br>UE产生AS安全秘钥用于target eNB的无线链路。首先从source eNB的KeNB/target cell的PCI和频点信息中生成KeNB*，接着通过target eNB选择的AS安全算法来生成target eNB的AS安全秘钥(KRRCint, KRRCenc, KUPenc) 。<br>11) [Source eNB -&gt; Target eNB] 通知发送或者接收的数据包序号<br>source eNB给target eNB发送SN Status Transfer 消息通知从哪个数据包开始发送或者接收，在这个消息中包含下行计数和上行计数，这个计数值是PDCP PDU的计数，每一个计数32bit，是由Hyper Frame Number (HFN) and PDCP Sequence Number (SN)组成。这个信息如下所示：<br><strong>SN Status Transfer</strong> (DL Count, UL Count)</p>
<ul>
<li>DL Count: Count of the first packet to send to the UE</li>
<li>UL Count: Count of the first packet to receive from the UE</li>
</ul>
<p>在发送给target eNB SN status transfer消息后，source eNB开始转发从SGW的下行数据包到target eNB。target eNB缓存这些数据包等待UE接入完成。</p>
<p>12) ~ 14) [UE, Target eNB] UE接入到target eNB</p>
<p>12) UE检测到target eNB的同步信号并执行同步到target eNB。一旦同步完成，UE发起非竞争的随机接入。</p>
<p>13) target eNB给UE发送定时偏移信息（时间提前量）和UL grant。</p>
<p>14) UE给target eNB发送handover confirm消息包含在RRC connection reconfiguration complete 消息。现在，UE可以发送或接收来自target eNB的数据包，切换中断时间周期结束。</p>
<p>15) [UE - Target eNB] 在无线链路上安全通信<br>UE和target eNB之间无线链路上的所有rrc信令消息和用户数据包都使用AS安全秘钥安全的传输。RRC信令消息是完整性保护和加密的，用户数据包是加密的。</p>
<p>16) [Target eNB] 恢复发送至UE的下行数据包<br>一旦UE成功连接到target eNB，target eNB开始通过图6的路径发送缓存的下行数据包给UE。至于UE发送的数据包，target eNB检查上行数据包是否以正确的顺序接收，并通过图6的路径转发给SGW。</p>
<p><strong>Handover Completion</strong><br>图7描述了X2切换完成阶段的详细过程。</p>
<p><img src="http://img.blog.csdn.net/20151009085152436" alt="这里写图片描述"></p>
<p>17) [Target eNB -&gt; MME] 请求EPS承载（S1承载）路径转换<br>target eNB通过发送path switch request消息通知EPC（MME）UE的服务消息转换了，并请求转换EPS承载路径。</p>
<p>18) ~ 23) 修改EPS承载<br>MME转发target eNB分配的S1 Target eNB TEID给SGW。通知SGW下行S1承载已经改变了，并要求改变这个承载路径。SGW建立下行S1承载连接到target eNB。一些SGW根据UE初始attach的设置的选项在EPS会话创建时需要报告UE的服务小区是否改变。在此场景下，S-GW向P-GW发一个modify bearer request消息，让P-GW向PCRF发送报告，根据EPS  session modification procedure，指示说UE的服务小区已经发生了改变。</p>
<p>24) [S-GW] 修改EPS承载路径并发送EM数据包<br>现在下行S1承载已经修改，SGW转换下行数据包交付路径到连接target eNB的下行S1承载。首先SGW发送结束标记EM来标识到达source eNB的下行S1承载的最后一个数据包。接着SGW通过修改过的下行S1承载发送下行数据包。</p>
<p>25) [Target eNB] 数据包重新排序<br>现在target eNB从source eNB和从修改过的下行S1承载接收下行数据包。所以，应该以一定的顺序交付给UE这些数据包。首先，target eNB交付给UE source eNB转发的下行数据包，当收到EM，target eNB知道这是从X2承载的最后一个数据包，接着target eNB发送从S1承载接收到的数据包给UE。</p>
<p>26) [Target eNB &lt;- MME] 通告修改过的承载路径<br>MME通过发送path switch request ack消息通知给target eNB，SGW已经完成了EPS承载路径的转换。接着，MME转发用于切换的安全上下文{NH Chaining Count (NCC), Next Hop (NH)}，target eNB可以在UE下次切换到另外一个小区时使用。</p>
<p>27) [Source eNB &lt;- Target eNB] 通知释放UE上下文<br>target eNB保留{NCC, NH}并给source eNB发送UE context release消息，通知UE上下文可以释放，UE承载路径转换完成。</p>
<h1 id="IV-EPS-Entity-Information-Before-After-X2-Handover"><a href="#IV-EPS-Entity-Information-Before-After-X2-Handover" class="headerlink" title="IV. EPS Entity Information: Before/After X2 Handover"></a>IV. EPS Entity Information: Before/After X2 Handover</h1><p>这章描述在X2切换前后EPS实体信息的变化。所有的信息被分类为UE ID，UE Location，安全，EPS会话/承载信息。</p>
<h2 id="4-1-Before-X2-Handover"><a href="#4-1-Before-X2-Handover" class="headerlink" title="4.1 Before X2 Handover"></a>4.1 Before X2 Handover</h2><p>在X2切换前，UE处于EMM-Registered and ECM/RRC-Connected状态。直到执行X2切换构成，所有的信息和初始附着/service request之后的信息相同。也就是，E-UTRAN和EPC分配的资源和存储在EPS实体中的UE上下文信息。图8列出来这些信息。</p>
<p><img src="http://img.blog.csdn.net/20151009085240097" alt="这里写图片描述"></p>
<h2 id="4-2-After-X2-Handover"><a href="#4-2-After-X2-Handover" class="headerlink" title="4.2 After X2 Handover"></a>4.2 After X2 Handover</h2><p>在X2切换后，UE处于EMM-Registered and ECM/RRC-Connected状态。存储在每一个EPS实体中的信息没有改变，但是UE的Location信息发生变化。在source eNB中所有的E-UTRAN资源和UE上下文都释放了，但是在target eNB中设置了。图9列出来这些信息。在图中，改变的信息被标记为蓝色。</p>
<p><img src="http://img.blog.csdn.net/20151009085318794" alt="这里写图片描述"></p>
<h1 id="V-Closing"><a href="#V-Closing" class="headerlink" title="V. Closing"></a>V. Closing</h1><p>到目前为止我们讨论了MME和SGW都不发生改变的X2切换过程。X2切换是在没有EPC参与下由source 和target eNB来执行的。我们学习了下行数据包通过X2传输承载转发来避免数据包丢失。在第三篇文档，我们将讨论S1切换，以及S1切换和X2切换的不同之处。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “LTE EMM Procedure 6. Handover without TAU – Part 1. Overview of Handover”, March 2014, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6224" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6224</a><br>[2] 3GPP TS 36.423, “Evolved Universal Terrestrial Radio Access Network (E-UTRAN); X2 application protocol (X2AP)”.<br>[3] 3GPP TS 36.331, “Evolved Universal Terrestrial Radio Access (E-UTRA); Radio Resource Control (RRC); Protocol specification”<br>[4] Netmanias Technical Document, “LTE Security II: NAS and AS Security”, August 2013, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903</a><br>[5] Netmanias Technical Document, “LTE Security I: LTE Security Concept and LTE Authentication”, July 2013, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5902" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5902</a><br>[6] NMC Consulting Group Confidential Internal Report, “E2E LTE Network Design”, August 2010</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/16-EMM-Procedure-6-Handover-without-TAU-Part-1-Overview-of-LTE-Handover/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/16-EMM-Procedure-6-Handover-without-TAU-Part-1-Overview-of-LTE-Handover/" itemprop="url">16-EMM Procedure 6. Handover without TAU - Part 1. Overview of LTE Handover</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:34:45+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6224" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6224</a></p>
<h1 id="I-Introduction"><a href="#I-Introduction" class="headerlink" title="I. Introduction"></a>I. Introduction</h1><p>这篇文档描述EMM case-6。这个过程是当UE移动到在TAI列表中的TA的一个小区时执行的。在handover过程中，并不发起TAU过程。我们定义这种过称为“Handover without TAU”。这个过程通过接下来的三篇文档讲述。第一个文档描述LTE handover，提供基本的信息。第二篇文档描述X2 handover，第三篇文档描述intra-LTE环境下的S1 handover。</p>
<h1 id="II-Overview-of-LTE-Handover"><a href="#II-Overview-of-LTE-Handover" class="headerlink" title="II. Overview of LTE Handover"></a>II. Overview of LTE Handover</h1><p>无线设备比有线的一个最大的好处就是它可以移动中使用服务。这种移动性可以使用户在任何位置使用该服务，不论是家里还是在路上，任何想要的时间都可以。正因为这种便利，无线用户大大超过有线用户。签约服务的用户可以在路上使用服务就是因为移动网络支持handover切换。UE可以从一个基站在不丢失数据的情况下切换到另外一个基站。这确保用户可以被无缝地服务到，不论连接到那个小区。这个文档描述UE和LTE实体需要采取什么行动来支持切换，并且简要的讲述这些行为的不同。和切换的过程如表1所示。</p>
<p><img src="http://img.blog.csdn.net/20150925133843129" alt="这里写图片描述"></p>
<p>UE有一个天线可以在多个band上搜索多个频率信道。所以在检查完多个邻区之后，UE通常接入有最强信号强度的那个小区（除非因为接入限制或者拥塞控制而不允许接入）。接着随着UE的移动和遮蔽，UE当前服务小区的接收信号强度变弱了，而邻区的信号变强，发起handover。允许UE接入邻区并建立新的RRC连接。</p>
<p>为了达到这种目的，当UE和eNB建立RRC连接时，eNB通过一个配置消息（RRC Connection Reconfiguration）给UE指示哪些事件的接收信号强度需要报告。UE监视服务小区和邻区的接收信号强度。当其中一个事件发生，UE通过Measurement Report消息把接收信号强度报告给eNB。eNB一旦接收到这个消息，通过查看报告强度信息和邻区的负载状态决定是否发起handover。一旦决定，将执行handover到选择的目的小区。</p>
<h2 id="2-1-Measurement"><a href="#2-1-Measurement" class="headerlink" title="2.1 Measurement"></a>2.1 Measurement</h2><p>图1描述了当UE测量和报告信号轻度的测量配置和测量报告过程。</p>
<p><img src="http://img.blog.csdn.net/20150925133953323" alt="这里写图片描述"></p>
<p><strong>(1) Measurement Configuration</strong><br>测量配置是由eNB提供给UE的，eNB指示什么类型的测量信息需要报告。eNB通过RRC connection reconfiguration消息提供给UE这些测量配置。这些信息包含如下：</p>
<ul>
<li>测量对象：提供UE需要测量的E-UTRAN小区，包括，频道号，物理小区ID-PCI，小区ID的黑名单，每一个小区的偏移值等等。</li>
<li>报告配置：指示需要UE发送测量报告信息的触发事件</li>
<li>测量ID：描述测量对象的ID</li>
<li>Quantity配置：指示UE测量的值</li>
<li>测量间隔：指示UE测量邻区的间隔</li>
</ul>
<p>在同频邻区测量情况下，UE可以不使用测量间隔(gap)来测量邻区。<br>但是在异频邻区测量时，UE应该首先同步到邻区的频点，然后在上下行idle周期内使用测量间隔gap来测量信号强度。</p>
<p><strong>(2) Measurement Report Triggering</strong><br>UE测量服务小区和邻区的信号强度。接着UE把测量结果报告给eNB（周期性的，或者在满足测量配置中设定的报告门限时触发测量事件）。E-UTRAN的报告门限包括事件A1, A2, A3, A4 and A5，在inter-RAT测量报告中包括事件 B1 and B2。Event A3通常用来触发切换。图2显示了由事件A3触发切换的实例。表2提供了事件A3使用的符号。</p>
<p><strong>Event A3</strong><br>当邻区的信号强度（信号强度和偏移，MNbr = Mn + Ofn + Ocn）比UE服务小区的信号强度（信号强度和偏移，MSer = Ms + Ofs + Ocs）高时，并且这个差额比A3偏移 (Off)还要大时，事件A3触发，UE给eNB报告测量结果。迟滞(Hys)是服务小区和目标小区越区切换界限的值。在A3触发的时候并且A3触发判决持续指定的TTT周期，eNB决定触发切换。</p>
<p><img src="http://img.blog.csdn.net/20150925134044972" alt="这里写图片描述"></p>
<p>Table 2. Definition of the Symbols Represented in E-UTRA Measurement</p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mn</td>
<td>Measurement result of the neighbor cell</td>
</tr>
<tr>
<td>Ms</td>
<td>Measurement result of the serving cell</td>
</tr>
<tr>
<td>Hys</td>
<td>Hysteresis parameter for Event A3</td>
</tr>
<tr>
<td>Off</td>
<td>Offset parameter of Event A3</td>
</tr>
<tr>
<td>Ofn</td>
<td>Frequency specific offset of the frequency of the neighbor cell</td>
</tr>
<tr>
<td>Ocn</td>
<td>Cell specific offset of the neighbor cell</td>
</tr>
<tr>
<td>Ofs</td>
<td>Frequency specific offset of the serving frequency</td>
</tr>
<tr>
<td>Ocs</td>
<td>Cell specific offset of the serving cell</td>
</tr>
</tbody>
</table>
<h2 id="2-2-Handover-Decision"><a href="#2-2-Handover-Decision" class="headerlink" title="2.2 Handover Decision"></a>2.2 Handover Decision</h2><p>当事件A3报告时，eNB决定执行什么类型的切换到哪一个目标小区，接着发起切换过程。切换可以分类为不同的类型，但是他们的分类遵循以下的目的：</p>
<p><strong>(1) Handover分类1: EPC实体是否发生变化</strong><br>切换可以分类为不同的类型–同频LTE，异频LTE，inter-RAT切换，这些根据UE连接的EPC实体在切换前后是否发生变化。</p>
<p><strong>同频LTE切换</strong><br>▪ Intra-MME/S-GW Handover: 在切换前后UE服务的MME和SGW是否发生变化</p>
<p><strong>异频LTE切换:</strong> 在切换前后UE服务的MME和/或SGW发生了变化<br>▪ Inter-MME Handover: 在切换后，UE服务MME发生变化，而服务的SGW保持不变<br>▪ Inter-S-GW Handover: 在切换后，UE服务SGW发生变化，而服务的MME保持不变<br>▪ Inter-MME/S-GW Handover: 在切换后，UE服务MME和SGW都发生了变化</p>
<p><strong>Inter-RAT Handover:</strong> 在不同无线接入技术之间的切换<br>▪ UTRAN to E-UTRAN<br>▪ E-UTRAN to UTRAN, etc.</p>
<p><strong>(2) Handover 分类2: 是否有EPC实体涉及到</strong><br>根据是否有EPC实体涉及到在源eNB和目标eNB之间准备和执行切换，LTE切换可以分为使用X2接口的X2切换和使用S1接口的S1切换。图3描绘了随着UE的移动而触发的两种不同类型的切换。图4显示了源eNB是如何决定是哪种类型的切换，X2或者S1。</p>
<p><strong>X2 Handover</strong><br>X2接口连接两个eNB。如果在两个服务小区的eNB和目标小区的eNB之间存在X2连接，并且X2连接可用于切换，则发起X2切换。一旦切换完成，两个eNB相互通信来控制切换，并没有MME的介入。</p>
<p><strong>S1 Handover</strong><br>S1接口连接eNB和EPC。如果i）在源eNB和目标eNB之间没有X2连接，ii）有X2连接，但是这个连接不允许用于切换，iii）在源小区和目标小区之间切换准备失败，则发起S1切换。一旦切换完成，源eNB通过MME和目标eNB通信控制切换。</p>
<p><img src="http://img.blog.csdn.net/20150925134242995" alt="这里写图片描述"><br><img src="http://img.blog.csdn.net/20150925134252671" alt="这里写图片描述"></p>
<h2 id="2-3-Handover-Procedure"><a href="#2-3-Handover-Procedure" class="headerlink" title="2.3 Handover Procedure"></a>2.3 Handover Procedure</h2><p>根据接收到的测量配置，UE把测量结果报告给eNB。一旦eNB决定，切换则发起。切换过程包含三个阶段–准备，执行，完成阶段。</p>
<p><strong>(1) Handover Preparation Phase</strong><br>在这个阶段，源eNB和目标eNB准备切换。对X2切换，通过X2信令两个eNB直接进行通信，并且不需要MME介入情况下执行。对S1切换，通过S1信令，需要MME介入。<br>源eNB发送用户UE上下文给目标eNB来检查目标eNB是否有能力提供满意的服务质量。如果可以，目标eNB建立传输承载（下行数据包转发承载）用于数据转发。接着分配C-RNTI（用于UE接入这个eNB），并把这个值转发给源eNB。这就完成了准备阶段。这时候对X2切换，下行数据包转发承载是一个连接两个eNB的直传隧道，对S1切换，则是连接三个实体的非直传隧道。图5标书了这个阶段的数据包转发路径，UL/DL承载数据交付路径，控制信息交付路径，和下行数据包转发路径。</p>
<p><img src="http://img.blog.csdn.net/20150925134325580" alt="这里写图片描述"></p>
<p><strong>(2) Handover Execution Phase</strong><br>在这个阶段，执行切换。UE从源eNB上释放无线连接，并连接到目标eNB，接入到新小区。一旦用于两个eNB之间数据包转发的资源(i.e. a DL packet forwarding bearer)分配完成，并且在准备阶段目标eNB为UE分配了新资源(i.e. a DRB, DL S1 bearer, C-RNTI, etc.)，则这两个eNB准备好切换了。接着源eNB通过发送handover command消息命令UE执行切换。在切换执行阶段，UE使用在切换准备阶段目标eNB分配的C-RNTI。这样可以使UE更快的接入目标eNB。一旦到达目标eNB，下行数据包通过转发承载转发给目标eNB，并缓存直到UE完成到目标eNB的接入。这确保了没有数据包丢失。从UE的上行数据包不转发直到UE成功的接入目标eNB。一旦UE完成对目标eNB的无线接入，上行数据立即通过目标eNB转发至SGW。图6描述了在切换执行阶段下行数据交付路径，和通过目标eNB上行数据交付路径。</p>
<p><img src="http://img.blog.csdn.net/20150925134405084" alt="这里写图片描述"></p>
<p><strong>(3) Handover Completion Phase</strong><br>一旦UE完成对目标eNB的无线接入，UE承载路径 (DL S1 bearer)连接到目标eNB上而不是源eNB上。一旦这个路径转换完成，在切换执行阶段使用的转发承载被释放。在图7中，一旦完成切换完成阶段，上下行数据都使用新承载来交付的。</p>
<p><img src="http://img.blog.csdn.net/20150925134441009" alt="这里写图片描述"></p>
<h2 id="2-4-切换中断时间"><a href="#2-4-切换中断时间" class="headerlink" title="2.4 切换中断时间"></a>2.4 切换中断时间</h2><p>在切换准备阶段，网络实体在执行切换时提前分配资源来确保没有下行数据包丢失。但是实际切换中，切换中断时间是不可避免的。在这个时间内（UE从源eNB释放无线资源到重新连接上新小区），数据包时不能在UE和小区之间交付的。图8显示了X2切换时切换中断时间的实例。如果中断时间持续过长，无缝服务将不支持，用户要承受差的服务质量。<br>切换中断时间包括：<br>❶ 下行同步到目标eNB的时间<br>❷ RACH等待时间<br>❸ 发送专用RACH preamble请求上行资源的时间<br>❹ 目标eNB检测到preamble 并处理的时间<br>❺ 准备RACH Response 的时间<br>❻ 解码RACH Response 的时间<br>❼ 通知UE已经完成到目标eNB切换的时间<br>❽ 在完成切换阶段获得目标eNB确认的时间</p>
<p><img src="http://img.blog.csdn.net/20150925134517615" alt="这里写图片描述"></p>
<h2 id="2-5-Mobility-Robustness-Optimization移动性鲁棒优化"><a href="#2-5-Mobility-Robustness-Optimization移动性鲁棒优化" class="headerlink" title="2.5 Mobility Robustness Optimization移动性鲁棒优化"></a>2.5 Mobility Robustness Optimization移动性鲁棒优化</h2><p>有时候，在切换执行阶段在UE完成接入到目标小区之前UE从服务小区或者目标小区接收到的信号不足够强将会导致无线链路失败RLF。RLF引起的因素有很多，可能和切换有关，也可能没关。如果是由切换执行时间相关的原因，切换发起的太早或者太晚都会引起RLF。如果在执行切换时RLF发生，UE可能会执行RRC重建过程，并连接到服务小区/目标小区或者另外一个小区（错误的小区）。RLF也和小区覆盖有关。所以，3GPP标准定义了移动鲁棒性优化（Mobility Robustness Optimization (MRO)）来帮助检测哪种类型的接入失败，并增强切换的鲁棒性。MRO超出本片文档的范围，将可能在LTE SON自组网文档中介绍。在下一个文档，我们将讨论没有RLF的成功切换。</p>
<h1 id="III-Closing"><a href="#III-Closing" class="headerlink" title="III. Closing"></a>III. Closing</h1><p>这篇文档，讨论了LTE切换的概述，讨论了小区测量，不同类型的切换和切换阶段。接下来的两篇文档将继续深入讨论X2和S1切换。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “Eleven EMM Cases in an EMM Scenario”, October 2013,<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002</a><br>[2] 3GPP TS 36.300, “Evolved Universal Terrestrial Radio Access (E-UTRA) and Evolved Universal Terrestrial Radio Access Network (E-UTRAN); Overall description”<br>[3] 3GPP TS 36.331, “Evolved Universal Terrestrial Radio Access (E-UTRA); Radio Resource Control (RRC); Protocol specification”<br>[4] NMC Consulting Group Confidential Internal Report, “E2E LTE Network Design”, August 2010</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/15-EMM-Procedure-5-Periodic-TAU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/15-EMM-Procedure-5-Periodic-TAU/" itemprop="url">15-EMM Procedure 5. Periodic TAU</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:34:32+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6193" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6193</a></p>
<h1 id="I-Introduction"><a href="#I-Introduction" class="headerlink" title="I. Introduction"></a>I. Introduction</h1><p>这篇文档描述EMM case-5 周期性TAU过程。这个过程是在ecm-idle rrc-idle状态下的UE因为没有数据传输而需要周期性的更新MME的位置信息。<br>当UE进入一个不在TAI列表中的TA时发起TAU，或者当TAU定时器超时。这篇文档介绍的是周期性TAU。当TAU定时器超时时，idle状态的UE发送TAU request消息报告自己的位置信息。在转移到ecm-connected rrc-connected状态后，执行周期性TAU过程，然后UE返回到idle状态。<br>这篇文档介绍idle状态的UE执行周期性TAU过程，第二章介绍周期性TAU的概念，第三章描述具体的过程，最后第四章总结在这个过程前后EPS实体信息的变化。</p>
<h1 id="II-Concept-of-Periodic-TAU"><a href="#II-Concept-of-Periodic-TAU" class="headerlink" title="II. Concept of Periodic TAU"></a>II. Concept of Periodic TAU</h1><p>在connected状态的UE已经建立UE到PGW的端到端的EPS承载。MME保持UE位置的跟踪。所以如果有到达UE的数据，网络可以立即传送。<br>但是如果UE在idle状态，UE和MME之间的信令连接和承载已经被释放，MME丢失了UE位置的跟踪。网络应该时刻知道UE的位置信息，无论是idle还是active，这是为了能够传送给UE数据。所以在idle状态的UE即使没有数据传输时，应该给MME周期性的报告自己的位置信息（比如UE所在的TA）。TA是一些小区的组合，由MME管理。idle状态的UE位置信息的识别是在TA级别。当UE初始附着网络时，MME会在attach accept消息中包含TAI列表和TAU定时器（T3412）给UE。使用这些信息，UE可以在TAU定时器超时时执行TAU过程。<br>当MME接收到UE的位置信息，MME会更新UE的最新位置信息。如果UE在idle状态下有数据到达UE，MME可以通过发送给这个TA下的所有小区寻呼信息来通知UE有数据到达，这个TA是idle状态的UE报告给MME的TA。图1描述了TAU执行的实例。UE1在初始附着时attach上了eNB1的cell2，并且通过attach accept由MME分配了TAI列表(e.g. TAI={TAI1, TAI2})和TAU timer (e.g.T3412=60 mins)，接着在转移到idle状态，❶ -&gt; ❷ -&gt; ❸ -&gt; ❹。我们假设i)UE只在TAI列表中的TAs中移动，ii）UE报告TA信息的MME是存储着UE的上下文信息，iii）MME和UE都包含有效的NAS安全上下文。</p>
<p><img src="http://img.blog.csdn.net/20150924131840678" alt="这里写图片描述"></p>
<p>在cell2 attach和转移到idle状态后，在t1时刻当TAU超时时UE1醒来并建立ECM信令连接。接着UE1发送给MME TAUrequest消息 (TAI=TAI1, Last Visited TAI=TAI1) 包含当前小区的TAI和上次访问的TAI(❶)。接着UE1接收到TAU accept消息后返回到idle状态。在接收到TAU request消息后，MME检查UE的上次TAI是否改变，如果变化了更新最新的TAI信息。如果有到达UE1的数据，SGW通知MME有下行数据，MME根据上次TAU报告的最新的TAI查找UE在哪个TA，并在这个TA下的所有小区发送寻呼消息。接下来，如果UE1移动到cell4，并且TAU定时器超时，UE给MME发送TAU request消息(TAI=TAI1, Last Visited TAI=TAI1)，因为UE一直在TA1中。如果UE1移动到cell11中，并且定时器超时，UE给MME发送TAU Request 消息(TAI=TAI2, Last Visited TAI=TAI1)，用TAI2代替TAI1，因为这个小区属于TAI2。接着MME更新UE1的上次TAI为TAI2。图2描述了连接建立，TAU前后用户面和控制面UE、MME的状态。</p>
<p><img src="http://img.blog.csdn.net/20150924131923513" alt="这里写图片描述"></p>
<p><strong>UE状态如下</strong>：<br>（i）在TAU之前，UE在EMM-Registered, ECM-Idle and RRC-Idle状态，E-UTRAN分配的资源，ECM信令连接都释放了。</p>
<p>（ii）在TAU过程中，UE处于EMM-Registered, ECM-Connected and RRC-Connected状态。周期性TAU过程不同于初始附着和service request过程，周期性TAU过程没有e-rab建立，只有ecm信令连接用于传输周期性TAU相关的NAS消息。</p>
<p>（iii）在TAU过程之后，ECM连接释放，释放E-UTRAN资源。接着UE返回到EMM-Registered, ECM-Idle and RRC-Idle状态。</p>
<p>图3描述了在TAU前后状态转换的过程。一旦T3412超时，idle状态的UE给MME发送TAU request报告当前TA和上次TA。MME在更新完最新UE位置信息后发送TAU accept消息。最后释放信令连接返回到idle状态。</p>
<p><img src="http://img.blog.csdn.net/20150924132015001" alt="这里写图片描述"></p>
<h1 id="III-Procedure-of-Periodic-TAU"><a href="#III-Procedure-of-Periodic-TAU" class="headerlink" title="III. Procedure of Periodic TAU"></a>III. Procedure of Periodic TAU</h1><p>图4和图5描述了周期性TAU的详细过程。图4中，UE的NAS通过发送TAU request消息给MME报告新的TA，更新类型标记为“Periodic Updating”。“Periodic Updating”类型的TAU不需要承载的建立，只需要建立ECM信令连接后就可以发送TAU request消息。当UE接收到TAU accept消息，释放ECM信令连接。TAU request消息是完整性保护。所以MME通过对这个消息完整性检查来决定是否执行鉴权过程。</p>
<p><img src="http://img.blog.csdn.net/20150924132102044" alt="这里写图片描述"></p>
<p><strong>❶  Periodic TAU Triggering</strong></p>
<p>1) [UE] TAU Timer Expiry<br>idle状态UE在T3412TAU定时器超时后出发TAU过程给MME报告自己的位置信息。</p>
<p><strong>❷  ECM Connection Establishment and TA Report</strong></p>
<p>UE的NAS层 i）配置TAU消息，ii）发送RRC参数给RRC层。</p>
<p>2), 3) [UE – eNB] RRC Connection Establishment<br>一旦接收到TAU request消息，UE的RRC层给eNB发送RRC connection request消息，请求专用信令资源。eNB通过分配SRB信道和给UE发送RRC connection setup消息来建立RRC连接。</p>
<p>4), 5), 6) [UE -&gt; MME] ECM Connection Establishment Request and TA Report<br>TAU request消息在UE到eNB之间包含在RRC Connection Setup Complete消息中，在eNB和MME之间包含在Initial UE Message消息中，TAU request消息是完整性保护和加密的。</p>
<p>The TAU Request消息如下信息:<br>TAU Request (Update Type=Periodic Updating, Active Flag=0, GUTI, Last Visited TAI, KSI ASME, NASMAC)</p>
<ul>
<li>Update Type: 标识TAU类型，当TAU定时器超时设置为Periodic Updating</li>
<li>Active Flag: 标识是否有上行用户数据或者信令要传送，如果有这个参数设置为1，会在TAU之后建立承载和维持ECM连接。</li>
<li>GUTI: UE ID, 之前由MME分配，用来标识UE的。</li>
<li>Last Visited TAI: UE上次注册的TAI</li>
<li>KSIASME: index for KASME, the NAS security base key</li>
<li>NAS-MAC: TAU request的消息完整性保护时使用MAC</li>
</ul>
<p>为了从NAS层接收TAU request消息，UE的RRC层在RRC Connection Setup Complete消息中包裹这个消息发送给eNB。这时，RRC Connection Setup Complete消息包含GUMMEI。这个ID是从NAS层接收的，标识UE注册在哪一个MME上。通常eNB可以连接不止一个运营商网络和MME，所以一旦接收到RRC Connection Setup Complete消息，eNB检查自己是否连接着这个标记的MME。接着，eNB把TAU request消息包裹在Initial UE Message消息中发送给MME。这时，eNB分配给initial UE message消息一个eNB S1AP UE ID标识。MME一旦接收到Initial UE Message消息，分配MME S1AP UE ID，并建立S1信令承载。这时候就完成了UE和MME之间的ECM信令连接，允许UE转移到connected状态。</p>
<p><strong>❸ UE Authentication and NAS Security Setup (Optional)</strong></p>
<p>7) [UE – MME – HSS] UE Authentication<br>MME一旦接收到TAU request消息，对这个消息进行完整性保护检查，如果检查通过，MME跳过UE鉴权过程，并继续使用自己保存的NAS安全上下文来传递NAS消息。如果检查失败了，需要执行UE鉴权。</p>
<p>8) [UE – MME] NAS Security Setup<br>一旦UE鉴权完成，NAS安全秘钥用于NAS消息传输。</p>
<p><img src="http://img.blog.csdn.net/20150924132148383" alt="这里写图片描述"></p>
<p><strong>❹  TA Update</strong></p>
<p>9) [MME -&gt; S-GW] TA Update<br>当MME接收到了TAU request消息后，重置TAU定时器，并给SGW发送Modify Bearer Request消息，转发UE的位置信息(ECGI, TAI)。</p>
<p>10) EPS Session Modification (Optional)<br>SGW接收到UE位置信息后，检查UE的小区是否发生变化。如果变化，SGW发送Modify Bearer Request消息给PGW通知这个变化。接着PGW通过EPS session modification过程发送同样的信息给PCRF。</p>
<p>11) [MME &lt;- S-GW] Responding to TA Update Request<br>SGW给MME发送Modify Bearer Response消息作为对Modify Bearer Request 消息的响应。</p>
<p>12) [MME] Preparing TAU Accept Message<br>MME配置新的TAI列表来反映UE当前位置，或者分配一个新的GUTI（根据实现来决定）。</p>
<p>13) [UE &lt;- MME] Sending TAU Accept Message<br>MME给UE发送TAU Accept 消息，完整性保护而且加密的。这个消息使用Downlink NAS Transport消息（从MME到eNB）和DL Information Transfer message消息（从eNB到UE）发送给UE。</p>
<p>14) [UE] Updating TIN and TAI List<br>当UE从MME接收到TAU Accept消息，检查GUTI和TAI列表值。如果这些值发生变化，UE会用新值来更新TIN (Temporary Identifier used in Next update)和TAI列表。这里的TIN是在下次UE发送TAU request消息时使用的用户ID，并且更新包含在TAU accept消息中的GUTI。</p>
<p>15) [UE] Acknowledging New GUTI<br>如果MME分配了一个新的GUTI，UE发送TAU complete消息给MME作为对新GUTI的响应。</p>
<p><strong>❺  ECM Connection Release</strong></p>
<p>16) [eNB &lt;- MME] Requiring E-UTRAN to Release UE Context<br>在更新UE的位置信息后，MME给eNB发送UE Context Release Command消息来释放用于周期TAU的ECM连接，并释放存储在E-UTRAN中的UE上下文。</p>
<p>17) [UE &lt;- eNB] Releasing RRC Connection<br>一旦接收到UE Context Release Command 消息，eNB释放UE上下文，并释放分配给UE的E-UTRAN资源。接着给UE发送RRC Connection Release消息来释放RRC连接，然后释放分配给UE的SRB。</p>
<p>18) [eNB -&gt; MME] Announcing Release of UE Context from E-UTRAN<br>eNB给MME发送UE Context Release Complete消息指示S1信令连接已经释放了。现在，为TAU request建立的ECM连接释放了，UE重新回到idle状态。(ECM/RRC-Idle)</p>
<h1 id="IV-EPS-Entity-Information-Before-After-Periodic-TAU"><a href="#IV-EPS-Entity-Information-Before-After-Periodic-TAU" class="headerlink" title="IV. EPS Entity Information: Before/After Periodic TAU"></a>IV. EPS Entity Information: Before/After Periodic TAU</h1><p>这章描述周期性TAU过程前后EPS实体的信息。所有的信息被分类为UE ID，UE Location，安全，EPS会话/承载信息。</p>
<h2 id="4-1-Before-Periodic-TAU"><a href="#4-1-Before-Periodic-TAU" class="headerlink" title="4.1 Before Periodic TAU"></a>4.1 Before Periodic TAU</h2><p>在TAU过程触发之前，UE在EMM-Registered, ECM-Idle and RRC-Idle状态，和service request发起之前存储的信息相同。即，E-utran分配的无线资源和相关的EPS承载和信令都被释放了。在图6中描述了在周期性TAU之前EPS实体中存储的信息。</p>
<p><img src="http://img.blog.csdn.net/20150924132239649" alt="这里写图片描述"></p>
<h2 id="4-2-After-Periodic-TAU"><a href="#4-2-After-Periodic-TAU" class="headerlink" title="4.2 After Periodic TAU"></a>4.2 After Periodic TAU</h2><p>在周期性TAU止呕，ECM连接释放，UE重新返回到idle状态。存储的EPS实体中的信息和TAU request之前的信息相同，如图6所示。</p>
<h1 id="V-Closing"><a href="#V-Closing" class="headerlink" title="V. Closing"></a>V. Closing</h1><p>我们学习了周期性TAU过程。不像service request过程，这个过程不建立e-rab承载，但是需要建立ECM连接。在TAU完成后，ECM连接释放，UE重新返回到idle状态。如果有上行数据要发送，首先建立e-rab承载，然后在TAU之后发送数据，像service request过程一样。接下来将介绍connected UE移动到另外的TA引起handover，但是没有TAU的情况。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “Eleven EMM Cases in an EMM Scenario”, October 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002</a><br>[2] Netmanias Technical Document, “LTE EMM Procedure 4. Service Request”, February 2014,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6134" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6134</a><br>[3] Netmanias Technical Document, “LTE Identification II: NE and Location Identifiers”, August 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5906" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5906</a><br>[4] Netmanias Technical Document, “LTE EMM Procedure 1. Initial Attach – Part 2. Call Flow of Initial<br>Attach”, January 2014, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102</a><br>[5] Netmanias Technical Document, “LTE Security I: LTE Security Concept and LTE Authentication”, July<br>2013, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5902" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5902</a><br>[6] NMC Consulting Group Confidential Internal Report, “E2E LTE Network Design”, August 2010</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/14-EMM-Procedure-4-Service-Request/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/14-EMM-Procedure-4-Service-Request/" itemprop="url">14-EMM Procedure 4. Service Request</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:34:11+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6134" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6134</a></p>
<h1 id="I-Introduction"><a href="#I-Introduction" class="headerlink" title="I. Introduction"></a>I. Introduction</h1><p>这篇文档描述EMM case-4：service request过程。这个过程是当有新流量时，在idle状态不活动的UE想激活来处理流量时执行的。新用户流量可以是从UE开始的上行流量，也可以是从网络到UE的下行流量。UE的E-UTRAN资源已经被释放了，UE处于ecm-idle rrc-idle状态。所以UE为了能够接受或者发送数据，UE需要通过service request过程来转换到ecm-connected rrc-connected状态，E-UTRAN资源被重新分配。<br>这个文档解释了LTE网络下的service request过程。第二章根据新流量产生在哪，对service request分为不同的类型。第三章和第四章描述了每一种service request详细过程的不同。最后第五章总结在service request前后EPS实体中信息的变化。</p>
<h1 id="II-Cases-of-Service-Request"><a href="#II-Cases-of-Service-Request" class="headerlink" title="II. Cases of Service Request"></a>II. Cases of Service Request</h1><p>当UE仍注册在网络，但是由于用户不活动删除了S1连接，UE没有可用的无线资源。这时候UE处于emm-registered和ecm-idle状态。如果这时候有新数据从UE产生或者从网络到UE，UE请求网络服务，转换到ecm-connected状态。ECM连接(RRC + S1 signaling connections)和e-RAB连接(DRB + S1 bearer)在控制面和用户面建立，允许UE接收或发送数据。如果网络发送数据给UE，网络会通知给UE自己的意图，让用户可以请求服务。<br>当UE有数据发送，或者从网络的意图中知道网络要发送数据，UE发送给MME service request消息，并转移到ecm-connected、rrc-connected状态。接着UE通过使用分配的无线和网络资源，可以接受和发送数据。service request可以由UE或者网络来触发，根据不同的触发情况，可以分类为以下几种：</p>
<ul>
<li>service request case-1：UE触发的新数据。当UE有新上行数据要发送给网络。</li>
<li>service request case-2：网络触发的新数据。当网络有下行数据要放给UE。</li>
</ul>
<p>图1展示了在service request执行前后用户面和控制面连接建立、UE和MME状态。在service request之前，用户时emm-registered ecm-idle rrc-idle状态。只有EPS分配的资源保持连接没有释放，而由E-UTRAN分配的所有资源都被释放了。在控制面S5 GTP-C and S11 GTP-C保持在连接状态。</p>
<p>在service request之前，用户处于EMM-Registered and ECM/RRC-Idle状态。只有EPC分配的资源没有被释放，e-utran分配的资源都释放了。在ECM连接丢失的情况下，在控制面S5 GTP-C和S11 GTP-C隧道仍然保持激活。在用户面，在下行S1承载和DRB被释放的情况下，S5承载和上行S1承载保持激活。</p>
<p>在service request之后，UE被e-utran分配了资源，处于emm-registered和ecm-connected rrc-connected状态。我们可以看到EPS承载的所有承载和连接以及信令连接都被建立起来用于传输数据。</p>
<p><img src="http://img.blog.csdn.net/20150923150915425" alt="这里写图片描述"></p>
<h1 id="III-UE-triggered-Service-Request"><a href="#III-UE-triggered-Service-Request" class="headerlink" title="III. UE-triggered Service Request"></a>III. UE-triggered Service Request</h1><p>图2和3描述了由UE触发的service request过程。UE的NAS通过service request消息给MME指示说UE有数据要发送。接着网络为数据传输分配资源。因为UE注册在网络，所以UE的NAS安全上下文在UE和MME中保持有效。所以UE可以发送加密和完整性保护的service request消息。当MME接收到这个消息，MME决定是否执行对用户的鉴权，尽管这个消息是加密和完整性保护的，接着eNB建立e-rab。</p>
<p><img src="http://img.blog.csdn.net/20150924081218601" alt="这里写图片描述"></p>
<p><strong>❶  ECM连接建立</strong></p>
<p>当有数据要发送，UE给MME发送service request消息建立ECM连接。service request消息通过无线链路上建立的RRC连接和S1信令连接传送给MME。这篇文档假设在UE和MME中有有效的GUTI和NAS安全上下文。</p>
<p>1), 2) [UE – eNB] RRC Connection Setup<br>UE的NAS层提供给RRC层S-TMSI。RRC层使用S-TMSI作为UEID发送RRC connection request消息到eNB来建立RRC连接。eNB返回给UE RRC connection setup消息。</p>
<p>3), 4), 5) [UE -&gt; MME] ECM Connection Setup Request<br>UE的NAS层发送service request消息给MME来建立ECM连接。NAS安全上下文已经存储在UE和MME中。这个消息中包含KSI-ASME，并且是加密和完整性保护的。service request消息包含在RRC connection setup complete 消息中传送给eNB的。这个消息是包含在S1AP消息（initial UE消息）中从eNB传送到MME的。这是，eNB分配eNB UE S1AP ID，并包含在initial UE消息消息中发送给MME。一旦接收到initial UE消息，MME分配MME S1AP UE ID，并和eNB之间建立S1信令连接。</p>
<p><strong>❷  UE鉴权和NAS安全建立(可选)</strong></p>
<p>6) [UE – MME – HSS] UE Authentication<br>在接收到service request消息后，MME执行完整性检查，如果通过，MME使用当前的NAS安全上下文传输NAS消息，并不对UE再执行鉴权流程。如果失败，MME会对UE执行鉴权流程。</p>
<p>7) [UE – MME] NAS Security Setup<br>当鉴权过程完毕后，UE和MME都生成了用于传输NAS消息的NAS安全秘钥。</p>
<p><img src="http://img.blog.csdn.net/20150924081319799" alt="这里写图片描述"></p>
<p><strong>❸  E-RAB 建立</strong></p>
<p>在收到service request消息之后，MME通过e-rab建立过程建立DRB和下行承载。</p>
<p>8) [eNB &lt;- MME] 请求E-RAB建立<br>一旦接收到UE发送的service request消息，MME意识到要建立e-rab。接着MME给eNB发送Initial Context Setup Request 消息，让eNB可以建立和SGW建立S1承载，和UE建立DRB。这个消息包含以下信息：</p>
<p>Initial Context Setup Request (E-RAB ID, KeNB, S1 S-GW TEID, MME UE S1AP ID)</p>
<ul>
<li>E-RAB ID</li>
<li>KeNB: AS安全基础秘钥，用来eNB和UE建立AS安全</li>
<li>S1 S-GW TEID: 标识连接到SGW的上行S1承载</li>
<li>MME UE S1AP ID: 标识连接到MME的S1信令承载</li>
</ul>
<p>9) [UE &lt;– eNB] AS Security Setup<br>在接收到initial context setup消息后，eNB意识到要建立DRB和S1承载用于用户数据传输。在建立DRB之前，eNB执行AS安全建立过程。UE和eNB通过AS安全建立过程生成KRRCint/KRRCenc用于加密和完整性保护，生成KUPenc 用于用户数据加密。<br>在成功完成AS安全建立，RRC消息在无线链路上是加密和完整性保护传输的，用户数据也是加密传输的。接着eNB开始DRB建立。</p>
<p>10) [UE &lt;- eNB] DRB Establishment<br>eNB分配一个DRB ID来创建DRB，并根据从MME接收到的e-rab QoS配置DRB QoS参数后，发送RRC connection reconfigutaion消息给UE。UE一旦接收到RRC Connection Reconfiguration消息，生成DRB和SRB2。</p>
<p>11) 上行传输通道可用<br>一旦完成步骤10生成DRB之后，就建立从UE到PGW的上行EPS承载，允许UE传输上行数据。</p>
<p>12) 13) &amp; 16) [eNB -&gt; S-GW] 建立下行S1承载<br>在步骤12，eNB为S1承载分配下行S1 TEID (S1 eNB TEID)，并把这个ID包含在initial context setup response消息中发送给MME，作为对Initial Context Setup Request消息的响应。MME把S1 eNB TEID包含在Modify Bearer Request消息中发送给SGW，SGW使用这个信息建立下行S1承载。接着，在步骤16，SGW通过Modify Bearer Response 消息通知MME下行S1承载建立完成。</p>
<p>14) 下行传输通道可用<br>一旦完成步骤13，从SGW到eNB的下行S1 GTP-U隧道就建立了，完成了从PGW到UE的下行EPS承载。用来传输下行数据给UE。</p>
<p>15) Modifying EPS Session (UE Location Registration)<br>在service request时如果UE的当前小区或者TA发送变化，SGW通知PGW这个变化。接着PGW通过EPS session medication过程报告给PCRF。</p>
<h1 id="IV-Network-triggered-Service-Request"><a href="#IV-Network-triggered-Service-Request" class="headerlink" title="IV. Network-triggered Service Request"></a>IV. Network-triggered Service Request</h1><p>图4和 5描述了网络触发的service request过程。这种类型的service request是当网络有下行数据要发送给UE时触发。MME不知道idle状态的UE处于什么位置，所以MME不得不通过寻呼过程来通知UE它有数据要发送，接着已经释放的承载资源可以重新建立。</p>
<p><img src="http://img.blog.csdn.net/20150924081422777" alt="这里写图片描述"></p>
<p><strong>❶  Service Request触发</strong><br>如果SGW从PGW通过S5承载收到下行数据包，但是不能通过下行S1承载发送给eNB，因为下行S1承载已经释放了。首先SGW缓存这些数据包，并找到UE注册在哪一个MME。接着SGW给MME发送Downlink Data Notification消息通知需要为UE建立信令连接和承载。</p>
<p><strong>❷  Paging</strong><br>MME知道UE驻留在哪一个TA，但是不知道UE驻留的小区。所以MME给这个TA下的所有eNB发送寻呼消息。eNB广播接收到的寻呼消息（通过PCH信道），UE在常规监控PCH时可以接收到这个消息。</p>
<p><strong>❸  ECM连接建立</strong><br>意识到有数据要到来，UE发送service request消息来建立ECM连接。ECM建立从UE通过无线接入信道接入小区开始，接着发送RRC Connection Request消息建立RRC消息。执行过程如图2所示。</p>
<p><strong>❹  UE鉴权和NAS安全（可选）</strong><br>MME一旦接收到UE发送的service request消息，如果NAS-MAC完整性检查失败，将实行UE鉴权和生成NAS安全秘钥。</p>
<p><img src="http://img.blog.csdn.net/20150924081508534" alt="这里写图片描述"></p>
<p><strong>❺  E-RAB 建立</strong><br>在从UE接收到service request消息后，MME通过e-rab建立过程建立DRB和下行S1承载。接着准备接收从SGW的数据包。详细过程如图3所示。</p>
<h1 id="V-EPS-Entity-Information-Before-After-Service-Request"><a href="#V-EPS-Entity-Information-Before-After-Service-Request" class="headerlink" title="V. EPS Entity Information: Before/After Service Request"></a>V. EPS Entity Information: Before/After Service Request</h1><p>这章将描述在service request前后EPS实体中信息的变化。所有的这些信息将分类为UE ID，UE Location，安全和EPS会话/承载信息。</p>
<h2 id="5-1-Before-Service-Request"><a href="#5-1-Before-Service-Request" class="headerlink" title="5.1 Before Service Request"></a>5.1 Before Service Request</h2><p>在service request触发之前，UE以为S1承载的释放而转移到emm-registered和ecm-idle rrc-idle状态。在S1承载释放后，所有EPS实体中的信息都保持相同直到service request过程执行。也就是说，E-UTRAN分配的无线资源和相关的EPS承载信令都从EPS实体中删除了。在图6中，在service request之前EPS实体中信息被标记为黑色。</p>
<p><img src="http://img.blog.csdn.net/20150924081600435" alt="这里写图片描述"></p>
<h2 id="5-2-After-Service-Request"><a href="#5-2-After-Service-Request" class="headerlink" title="5.2 After Service Request"></a>5.2 After Service Request</h2><p>一旦完成service request过程，UE转移到ECM/RRC-Connected状态，RRC连接、S1信令和e-rab承载都建立起来了。用于UE和PGW之间传输的所有需要的信息都存储在EPS实体中。图7描述了在service request之后，EPS实体中存储的信息。</p>
<p><img src="http://img.blog.csdn.net/20150924081642577" alt="这里写图片描述"></p>
<h1 id="VI-Closing"><a href="#VI-Closing" class="headerlink" title="VI. Closing"></a>VI. Closing</h1><p>这篇文档，学习了service request过程。总结了存储在EPS实体中的信息。接下来的文档将讨论TAU过程。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “Eleven EMM Cases in an EMM Scenario”, October 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002</a><br>[2] Netmanias Technical Document, “LTE EMM Procedure 1. Initial Attach – Part 2. Call Flow of Initial<br>Attach”, January 2014, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102</a><br>[3] Netmanias Technical Document, “LTE Security II: NAS and AS Security”, August 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903</a><br>[4] Netmanias Technical Document, “LTE EMM Procedure 3. S1 Release”, January 2014,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6110" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6110</a><br>[5] NMC Consulting Group Confidential Internal Report, “E2E LTE Network Design”, August 2010</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/13-EMM-Procedure-3-S1-Release/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/13-EMM-Procedure-3-S1-Release/" itemprop="url">13-EMM Procedure 3. S1 Release</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:19:40+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6110" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6110</a></p>
<hr>
<h1 id="I-Introduction"><a href="#I-Introduction" class="headerlink" title="I. Introduction"></a>I. Introduction</h1><p>这个文档 描述了EMM case-3，当UE不活动状态时释放S1连接。当注册到网络的UE处于不活动状态，没有使用任何服务（并不意味着不适用eNB分配的无线资源）。所以网络需要释放这些相关的无线接入相关的资源，并删除相关的信息（ID，QoS参数等等）。<br>从网络的角度看，S1释放意味着和UE有关的控制面S1信令和RRC连接，以及用户面下行S1承载和DRB。<br>但是，从UE的角度来看，它意味着在控制面和用户面丢失RRC连接和DRB。一旦S1连接释放，MME和UE之间的ECM连接也丢失了，在eNB中和UE相关的所有上下文都被删除了。接着用户从ecm-connected状态转移到ecm-idle状态，但是一直保持emm-registered状态。<br>这个文档解释了LTE网络中因为用户的不活动引起的S1释放。第二章描述了S1释放是怎么执行的，第三章描述了在S1释放过程之后信息单元是怎么变化的。</p>
<h1 id="II-S1-Release-due-to-User-Inactivity"><a href="#II-S1-Release-due-to-User-Inactivity" class="headerlink" title="II. S1 Release due to User Inactivity"></a>II. S1 Release due to User Inactivity</h1><p>S1释放可以被eNB或者MME触发。eNB触发的释放原因有：</p>
<ul>
<li>用户不活动</li>
<li>RRC信令完整性校验失败（再三）</li>
<li>因为UE产生信令连接释放而释放</li>
<li>未知错误</li>
<li>O&amp;M干预</li>
</ul>
<p>MME触发的释放原因有：</p>
<ul>
<li>鉴权失败</li>
<li>detach</li>
<li>不允许CSG小区</li>
</ul>
<p>另外，S1释放可以被其他另外两个因素，例如处理超负荷，没有足够可用的用户面处理资源等等。<br>图1展示了在S1释放前后，控制面和用户面UE和MME的状态。在释放前，EPS承载和信令连接建立来支持用户网络之间的流量传输。EPS承载包括DRB，S1承载，S5承载。信令连接包含ECM（RRC+S1信令连接），S11和S5连接。UE和MME都在emm-registered状态和ecm-connected状态，UE和eNB在rrc-connected状态。<br>在S1释放后，用户面的DRB和下行S1承载被释放，在控制面ECM（RRC+S1信令连接）连接丢失，释放E-UTRAN资源。应该注意的是，这时候只有下行S1承载释放了，上行的S1承载还在保持着。<br>S1释放不同于在detach过程中释放一样。在detach过程中，所有分配给UE的资源都被释放，UE转移到emm-deregistered状态。而在S1释放过程中，只有由无线接入网络分配的这些资源释放，而被EPC分配的资源则没有释放。所以UE保持在emm-registered状态，转移到ecm-idle状态。在接下来，当有上下行用户流量时，ECM连接和DRB/S1承载（下行）建立起来，UE状态转到ecm-connected并传输用户流量。</p>
<p><img src="http://img.blog.csdn.net/20150922144852795" alt="这里写图片描述"></p>
<p>图2描述了由eNB触发的一旦用户不活动时S1释放过程。在由MME触发的S1释放情景中步骤1和2保留。</p>
<p><img src="http://img.blog.csdn.net/20150922144951281" alt="这里写图片描述"></p>
<p>1）【eNB-&gt;MME】请求UE上下文释放<br>一旦检测到用户不活动，eNB发送给MME UE Context Release Request消息，伴随着释放的原因，来释放UE上下文。</p>
<p>2）【MME-&gt;SGW】请求S1承载释放<br>MME通过发送给SGW Release Access Bearers Request消息来请求SGW释放和eNB关联的资源，S1的下行端口。通过这个消息，通知SGW没有下行流量传输给UE了。</p>
<p>3）【SGW】下行S1承载释放<br>SGW释放和UE关联的所有下行S1承载（eNB相关的资源，包含eNB分配的下行S1 TEID等等）但是保留着上行S1承载资源（SGW相关的资源，包括上行S1 TEID和自己分配的上行S1 TEID等等）。所以当上行数据包到达时，eNB可以保持上行S1 TEID，通过S1承载无延迟的传输这些数据包。</p>
<p>4）【MME&lt;-SGW】响应S1 Bearer Release Request<br>SGW通过发送Release Access Bearers Response消息来确认下行S1承载资源已经被释放了。之后，如果有到达UE的下行数据包到达，SGW缓存他们，然后在下行S1承载重建之后再传输。详细的步骤将在下面文档中解释EMM case-4、</p>
<p>5）【eNB&lt;-MME】UE Context Release Command<br>MME给eNB发送UE Context Release Command消息来释放存储在eNB中的UE上下文。</p>
<p>6) [UE &lt;- eNB] RRC Connection Release<br>eNB一旦从MME接收到命令，将删除eNB具有所有UE上下文。如果RRC连接还没有释放，eNB发送给UE RRC Connection Release消息来释放。通过这个消息，eNB释放和UE相关的所有无线资源和承载，并伤处UE上下文。</p>
<p>7) [eNB -&gt; MME] UE Context Release Complete<br>eNB给MME发送UE Context Release Complete message作为步骤5的响应。MME确认UE所有的上下文已经删除了。</p>
<p>8) 【MME】 S1 Release<br>MME释放在UE上下文中所有eNB相关的信息，除了上行S1承载信息。但是保留和eNB不关联的信息。</p>
<h1 id="III-EPS-Entity-Information-Before-After-S1-Release"><a href="#III-EPS-Entity-Information-Before-After-S1-Release" class="headerlink" title="III. EPS Entity Information: Before/After S1 Release"></a>III. EPS Entity Information: Before/After S1 Release</h1><p>这章将学习在S1释放前后EPS实体中信息的变化。所有的信息分类为UE ID，UE Location，安全和EPS会话/承载信息。</p>
<h2 id="3-1-Before-S1-Release"><a href="#3-1-Before-S1-Release" class="headerlink" title="3.1 Before S1 Release"></a>3.1 Before S1 Release</h2><p>在S1释放之前，UE连接到网络，在EMM-Registered, ECMConnected and RRC-Connected 状态下使用服务。所有的EPS实体保持着和初始附着后相同的信息。图3列出来在S1释放之前所有EPS实体的信息。</p>
<p><img src="http://img.blog.csdn.net/20150922145045998" alt="这里写图片描述"></p>
<h2 id="3-2-After-S1-Release"><a href="#3-2-After-S1-Release" class="headerlink" title="3.2 After S1 Release"></a>3.2 After S1 Release</h2><p>在S1释放之后，UE仍然注册在网络上，但是是在EMM-Registered, ECM-Idle and RRC-Idle状态，不使用任何服务。因为UE和任何eNB没有连接，所有UE请求连接eNB和传输数据需要的信息被释放。在控制面，ECM连接（RRC和S1信令连接）被释放，在用户面DRB和下行S1承载被释放。图4列出了在S1释放之后每一个实体中的信息。在S1释放的信息被标记为灰色。</p>
<p><img src="http://img.blog.csdn.net/20150922145116068" alt="这里写图片描述"></p>
<p>在UE中删除的信息：</p>
<ul>
<li>C-RNTI：在UE要连接小区中标识UE的ID。</li>
<li>ECGI：在UE要连接的小区上的信息</li>
<li>DRB ID：在无线链路上的EPS承载的ID。由eNB分配给UE。</li>
<li>AS Security Info: 在UE和eNB之间的AS安全上下文。</li>
</ul>
<p>在eNB中删除的信息：</p>
<ul>
<li>所有的信息</li>
</ul>
<p>在MME删除的信息：</p>
<ul>
<li>S1AP UE ID：用在S1信令连接的UE ID信息(eNB S1AP UE ID and MME S1AP UE ID)</li>
<li>ECGI: 在UE要连接的小区上的信息</li>
<li>S1 TEID (DL): 在下行S1承载上使用的TEID信息</li>
</ul>
<p>在SGW删除的信息</p>
<ul>
<li>S1 TEID (DL): 在下行S1承载上使用的TEID信息</li>
<li>ECGI: 在UE要连接的小区上的信息</li>
</ul>
<h1 id="IV-Closing"><a href="#IV-Closing" class="headerlink" title="IV. Closing"></a>IV. Closing</h1><p>我们已经讨论完了当用户不活动时S1释放过程。接下来我们学习service request过程。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “Eleven EMM Cases in an EMM Scenario”, October 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002</a><br>[2] Netmanias Technical Document, “LTE EMM Procedure 1. Initial Attach – Part 2. Call Flow of Initial<br>Attach”, January 2014, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102</a><br>[3] NMC Consulting Group Confidential Internal Report, “E2E LTE Network Design”, August 2010</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/12-EMM-Procedure-2-Detach/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/12-EMM-Procedure-2-Detach/" itemprop="url">12-EMM Procedure 2. Detach</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:19:31+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6108" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6108</a></p>
<hr>
<h1 id="I-Introduction"><a href="#I-Introduction" class="headerlink" title="I. Introduction"></a>I. Introduction</h1><p>这篇文档讨论EMM case-2。在这个过程中，用户从附着的网络上去附着。用户在EMM case-1通过初始附着附着到网络上在emm-registered状态使用LTE服务，在使用服务后，当在ECM/RRC-connected状态或者ECM/RRC-idle状态下用户可能被网络或者UE去附着。无论任何一种情况，一旦去附着过程完毕，用户的EPS承载释放并且状态信息清除。</p>
<p>这篇文档介绍LTE网络的detach过程，组织如下：第二章根据detach是谁发起的来定义不同的类型，第三章描述每一个detach类型的具体过程，第四章深入了解在detach后每一个EPS实体的信息有如何变化。</p>
<h1 id="II-Cases-of-Detach"><a href="#II-Cases-of-Detach" class="headerlink" title="II. Cases of Detach"></a>II. Cases of Detach</h1><p>通过初始附着生成EPS会话和默认EPS承载之后用户可以使用LTE服务。在一些情况下，用户一旦使用完了服务可以may从网络detach。在另外一些情况下，用户一直在使用网络服务时被网络detach，然后不能和网络保持连接了。</p>
<p>一旦用户从网络detach，所有分配给这个用户的EPS会话和承载都将被释放。释放过程将删除用户的MM上下文和给EPS实体设置的EPS承载。这时，EMM状态从registered转到de-registered。如果用户正确的detach了，GUTI，NAS层的用户ID和安全上下文，用户接入网络所需要的这些信息都将在UE和MME中保持有效，所以用户可以在下一次接入网络时使用这些信息。</p>
<p>detach可以由UE和网络来触发。网络触发的detach是由MME或者HSS引起的。<br>detach根据在哪里触发可以分为以下几类：<br><strong>1) Detach Case 1: UE发起的Detach</strong><br>UE可以发起detach:</p>
<ul>
<li>如果UE关机</li>
<li>USIM从UE中移除</li>
<li>UE试图使用non-EPS服务（比如，CSFB，SMS等等）</li>
</ul>
<p><strong>2) Detach Case 2: MME发起的Detach</strong><br>MME发起detach可以更信息分为显式detach和隐式detach。<br>对于显式detach，MME通过发送detach request消息提前通知UE它要detach，并通知UE在detach之后是否要重新attach。<br>对于隐式detach，MME不通知UE就发起detach过程，因为UE没有能力和MME通信。<br>MME可以发起<br> i)显式detach</p>
<ul>
<li>运营商O&amp;M（操作或者维护）的目的</li>
<li>重新鉴权失败</li>
<li>如果MME不能为用户提供分配资源</li>
</ul>
<p>ii）隐式detach</p>
<ul>
<li>由于无线链路质量比较差导致不能和用户通信（比如RLF）</li>
</ul>
<p><strong>3) Detach Case 3: HSS发起的Detach</strong><br>HSS可以发起detach:</p>
<ul>
<li>如果HSS提供的用户配置文件发生变化，保存在MME中的配置文件也不得不改变时</li>
<li>如果运营商试图限制一个非法的UE接入网络</li>
</ul>
<p>在下面几章中，我们将描述下面三种类型的详细过程。在这个三个类型中，假设用户在detach之前处于emm-registered ecm-connected rrc-connected状态，并且仅仅通过默认EPS承载提供服务。图1描述了建立了哪些连接，在detach前后用户和控制面的UE和MME都处于什么状态。在detach之前，已经建立默认EPS承载和相关的控制连接，用户处于emm-registered ecm-connected rrc-connected状态。在detach之后，默认EPS承载和所有的信令连接都被释放，用户进入EMM-Deregistered, ECM-Idle and RRC-Idle状态。</p>
<p><img src="http://img.blog.csdn.net/20150922121632123" alt="这里写图片描述"></p>
<h1 id="III-UE-initiated-Detach"><a href="#III-UE-initiated-Detach" class="headerlink" title="III. UE-initiated Detach"></a>III. UE-initiated Detach</h1><p>图2展示了用户发起的detach是怎么执行的。用户发起的detach是由UE触发的，由UE发送detach request消息。当UE接收到MME的detach accept消息（除非用户关机情况下）这个过程结束。</p>
<p><img src="http://img.blog.csdn.net/20150922121934689" alt="这里写图片描述"></p>
<p><strong>❶ UE触发detach</strong><br>当检测到UE触发detach，UE和MME都能感知到，这两个实体开始以下的过程：<br>1）【UE-&gt;MME】detach request<br>UE通过发送detach request消息给MME，请求MME detach。detach request消息参数根据这个消息传送的方向有不同的解释。如果是从UE到MME，这个消息参数如下所示：<br>Detach Request (GUTI, KSIASME, Detach Type(Switch Off))</p>
<ul>
<li>GUTI：MME在网络attach时分配的用户ID</li>
<li>KSI-ASME：UE使用的KSI值</li>
<li>detach type：只是detach的类型<ul>
<li>switch off：只是detach是normal detach（0）还是switch off（1）</li>
<li>type of detach：EPS detach</li>
</ul>
</li>
</ul>
<p>2）【UE】处理安全和承载上下文<br>在发送完detach request消息后，UE存储它当前NAS安全上下文，GUTI和TA信息，并删除EPS承载上下文。</p>
<p>3）【MME】通知detach意图和处理安全上下文<br>在接收到detach request消息后，MME可以知道UE detach的意图。并存储用户当前NAS安全上下文，检查detach的类型，例如，是否是normal detach或者关机。通过上述步骤，MME可以知道是否需要发送detach accept消息。</p>
<p><strong>❷ EPS会话终止</strong><br>一旦MME感知到UE发起的detach并存储用户当前NAS安全上下文，请求对已经激活EPS会话的终止。这个请求触发PCEF（PGW）发起EPS终止，释放所有分配给用户的网络/无线资源。</p>
<p><strong>1）EPS承载释放和PCC策略移除</strong><br>4）【MME-&gt;SGW】请求EPS会话释放<br>MME和SGW在S11接口上通过GTP-C协议通信。MME通过发送给SGW一个delete session request消息来请求删除用户的会话和默认EPS承载。这时，在消息中传递 默认EPS承载ID和UE位置信息 (ECGI, TAI)。</p>
<p>5）【MME】删除EPS承载上下文<br>MME在发送delete session request消息后删除用户EPS承载上下文。</p>
<p>6）【SGW-&gt;PGW】请求EPS会话释放<br>SGW和PGW在S5接口上通过GTP协议相互通信。SGW转发从MME接收到的delete session request消息给PGW。</p>
<p>7）【SGW】删除EPS承载上下文<br>SGW在发送delete session request消息后删除用户EPS承载上下文。</p>
<p>8）【PGW-&gt;PCRF】通知EPS会话终止<br>PGW和PCRF在Gx接口上通过Diameter协议通信。PGW发送给PCRF一个CCR（CC-request）消息来通知PCRF用户已经结束了使用服务。这样，它就可以发起EPS会话终止过程。</p>
<p>9）【PCRF】删除PCC策略<br>一旦PCRF从PGW收到CCR消息，PCRF删除用户的PCC策略。</p>
<p>10）【PGW&lt;-PCEF】确认EPS会话终止<br>PCRF通过发送给PGW CCA（CC-answer）消息来确认用户的PCC策略已经删除了。</p>
<p>11）【SGW&lt;-PGW】响应EPS delete session request<br>当PGW从PCRF接收到CCA消息，PGW发送给SGW一个Delete Session Response消息作为对delete session request消息的响应。</p>
<p>12）【PGW】删除EPS承载上下文<br>在发送delete session response消息后，PGW删除用户的EPS承载上下文。</p>
<p>13）【MME&lt;-SGW】响应EPS Session Release Request<br>当SGW从PGW接收到delete session response消息后，SGW发送给MME delete session response消息作为对delete session request消息的响应。</p>
<p>14）【MME&lt;-UE】确认detach<br>一旦接受到delete session response消息，MME确认用户资源释放已经由PCRF同意了。接着MME发送给UE detach accept接收到作为detach request消息的响应。detach accept消息仅仅当UE的detach请求原因除关机之外的情况下才发送。如果detach 请求原因是因为设备关机，么么不会发送detach accept消息。</p>
<p><strong>(2) S1信令连接释放</strong><br>一旦发送完detach accept 消息给UE之后，么么和eNB释放分配给用户的所有资源（S1信令连接，RRC连接和eNB中的UE上下文），以为UE不要他们的服务了。</p>
<p>15）【eNB&lt;-MME】确认S1信令连接释放<br>MME发送UE Context Release Command给eNB来释放S1信令连接。</p>
<p>16）【UE&lt;-】RRC连接释放<br>eNB发送RRC Connection Release消息给UE来释放任何没有释放的RRC连接。</p>
<p>17）【eNB】删除UE上下文<br>eNB删除所有和UE相关的信息。</p>
<p>18）【eNB-&gt;MME】RRC Connection Release Complete<br>最后eNB发送给MME UE Context Release Complete消息作为对15）请求消息的响应。</p>
<h1 id="IV-MME-initiated-Detach"><a href="#IV-MME-initiated-Detach" class="headerlink" title="IV. MME-initiated Detach"></a>IV. MME-initiated Detach</h1><p>图3显示了MME发起的detach是怎么执行的。MME发起的detach是由MME触发，接着MME发送detach request消息给UE，当分配UE的EPS会话资源都被释放后这个过程结束。</p>
<p><img src="http://img.blog.csdn.net/20150922122055404" alt="这里写图片描述"></p>
<p><strong>❶ MME触发的detach</strong><br>下面描述了MME检测到detach触发之后，在EPS会话终止过程执行之前的步骤。如果用户这时处于idle状态，MME执行寻呼来建立S1信令连接。<br>1）【UE-&gt;MME】detach request<br>因为这是一个显式detach，MME发送detach request消息来请求UE detach。消息参数包含如下：<br>Detach Request (Detach Type(Re-attach required or not), Cause)</p>
<ul>
<li>detach type：指示UE在detach之后是否需要重新attach（001-需要重新attach，010-不需要重新attach）</li>
<li>cause：指示detach的原因</li>
<li>对于隐式detach，MME不发送detach request消息给UE。</li>
</ul>
<p>2）【MME】处理安全上下文<br>在发送detach request消息给UE之后，MME在删除EPS会话之前存储当前NAS安全上下文。下次重新attach时，MME可以使用这些存储的上下文，并跳过鉴权和ＮＡＳ安全建立过程。</p>
<p>3）【UE】通知detach意图和处理安全承载上下文<br>在接收到MME发送的detach request后，UE获知MME detach的意图。UE检查detach的类型是否需要在detach之后重新attach。然后存储当前NAS安全上下文，并删除EPS承载上下文。</p>
<p><strong>❷ EPS会话终止</strong><br>一旦MME存储NAS安全上下文，MME请求PGW终止用户的EPS会话。这个请求触发PCEF（PGW）发起EPS终止过程，释放分配给用户的所有网络无线资源。<br><strong>（1）EPS承载释放和PCC规则移除</strong><br>通过4）~13），MME请求终止用户EPS会话，PCEF一旦接收到请求删除PCC规则，删除S5承载资源。在MME发起的detach中需要重新attach时，MME可以保存当前的UE-AMBR，在下次重新attach时UE可以更快的建立EPS承载。</p>
<p>14）【UE-&gt;MME】确认detach<br>一旦接收到detach request消息，在存储NAS安全上下文和删除EPS承载上下文之后，UE发送detach accept消息作为detach request像爱惜的响应。对于隐式detach的情况，1）14）16）步骤是跳过的。</p>
<p>（2）S1信令连接释放<br>在这节中，MME在接收到UE发送的detach accept消息和从SGW发送的delete session response消息后，释放所有未释放的资源。这节的过程和第三章的15-18步相同，除了detach 类型是允许重新attach，UE是在RRC连接释放完成后重新attach到网络的。</p>
<h1 id="V-HSS-initiated-Detach"><a href="#V-HSS-initiated-Detach" class="headerlink" title="V. HSS-initiated Detach"></a>V. HSS-initiated Detach</h1><p>图4描述了HSS发起detach的过程</p>
<p><img src="http://img.blog.csdn.net/20150922122158199" alt="这里写图片描述"></p>
<p><strong>❶ HSS触发的detach</strong><br>当因为签约信息退回由HSS触发detach，HSS试图立即删除用户的MM上下文和EPS承载。<br>1) 【MME&lt;-HSS】 Detach Request<br>HSS和MME在S6a接口上通过Diameter协议相互通信。HSS通过发送请求给MME Cancel Location Request (CLR)消息来detach用户。使用以下参数：<br>Cancel Location Request (IMSI, Cancellation Type)</p>
<ul>
<li>IMSI：要detach的用户ID</li>
<li>cancellation type = Subscription Withdrawn：指示detach的原因</li>
</ul>
<p><strong>❷ EPS会话终止</strong><br>一旦从HSS接收到Cancel Location Request (CLR) 消息，MME释放之前分配给UE的所有资源。这个步骤和MME发起detach的过程是一样的，除了在2）中描述的额外的步骤。MME需要发送给HSS Cancel Location Answer消息作为Cancel Location Request消息的响应。</p>
<p>2) [MME -&gt; HSS] 响应Detach Request<br>一旦从UE接收到detach accept消息，和从SGW接收到delete session response消息，MME会发送给HSS Cancel Location Answer消息作为Cancel Location Request消息的响应。</p>
<h1 id="VI-EPS-Entity-Information-Before-After-Detach"><a href="#VI-EPS-Entity-Information-Before-After-Detach" class="headerlink" title="VI. EPS Entity Information: Before/After Detach"></a>VI. EPS Entity Information: Before/After Detach</h1><p>这章描述了在执行“EMM Case 2: Detach”步骤之后EPS实体中的信息是如何变化的。每一个实体中的所有信息被分类为UE ID，UE Location，安全和EPS会话/承载信息。</p>
<h2 id="6-1-Before-Detach"><a href="#6-1-Before-Detach" class="headerlink" title="6.1 Before Detach"></a>6.1 Before Detach</h2><p>在detach之前用户处于ECM/RRC-Connected状态。所以在detach之前，所有的EPS实体都有和初始附着完成后他们具有的信息相同。图5列出了在detach之前每一个实体中所有的信息。</p>
<p><img src="http://img.blog.csdn.net/20150922122259375" alt="这里写图片描述"></p>
<h2 id="6-2-After-Detach"><a href="#6-2-After-Detach" class="headerlink" title="6.2 After Detach"></a>6.2 After Detach</h2><p>在detach之后，用于用户下次更快和安全attach的信息存储在UE和MME中。所有和用户相关的其他上下文信息，例如NAS安全上下文，GUTI，MME分配的TAI信息都将会释放。图6列出了在detach之后每一个EPS实体中的信息。在detach之后需要删除的信息标示为灰色，不要保留的信息标示为黑色，在下次attach时需要使用的信息被表示为蓝色。</p>
<p><img src="http://img.blog.csdn.net/20150922122350816" alt="这里写图片描述"></p>
<h1 id="VII-Closing"><a href="#VII-Closing" class="headerlink" title="VII. Closing"></a>VII. Closing</h1><p>我们已经学习了连接到LTE网络的用户从网络detach的过程。我们根据触发的位置分类detach类型，并对每一种类型进行详细的讲解。我们对比了detach前后每一个实体存储信息的变化。接下来的文档将讨论在用户不活动时删除S1资源的情况。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “Eleven EMM Cases in an EMM Scenario”, October 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002</a><br>[2] Netmanias Technical Document, “LTE EMM Procedure 1. Initial Attach – Part 2. Call Flow of Initial<br>Attach” , January 2014, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102</a><br>[3] NMC Consulting Group Confidential Internal Report, “E2E LTE Network Design”, August 2010</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/11-EMM-Procedure-1-Initial-Attach-Part2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/11-EMM-Procedure-1-Initial-Attach-Part2/" itemprop="url">11-EMM Procedure 1. Initial Attach Part2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:19:18+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>EMM Procedure 1. Initial Attach<br>Part 2. Call Flow of Initial Attach</p>
<p>原文链接：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6102</a></p>
<hr>
<h1 id="I-Introduction"><a href="#I-Introduction" class="headerlink" title="I. Introduction"></a>I. Introduction</h1><p>我们首先详细探讨EMM case-1：unknown UE的初始附着。这是当用户在签约LTE网络之后，首次打开UE并尝试附着到网络上。之前被分类为attach case-1。</p>
<p>这个文档组织如下：第二章讨论EMM case-1的详细过程，关注在在这个case中的功能需求。第三章描述在初始附着之后每一个实体中哪些信息发生了变化。</p>
<h1 id="II-Initial-Attach-Procedure"><a href="#II-Initial-Attach-Procedure" class="headerlink" title="II. Initial Attach Procedure"></a>II. Initial Attach Procedure</h1><p>图1描述了EMM case1的初始附着过程，还有在每一个流程中的功能模块需求。</p>
<p><img src="http://img.blog.csdn.net/20150918081437944" alt="这里写图片描述"></p>
<h2 id="2-1-IMSI获取"><a href="#2-1-IMSI获取" class="headerlink" title="2.1 IMSI获取"></a>2.1 IMSI获取</h2><p>图2展示了这个流程中的第一步。在这一步结束后，MME从UE获得IMSI。UE用attach request包含IMSI试图初始附着到网络上，MME从这个消息中获得IMSI。这一步可以细分为两小步：1）UE在无线连接同步之后待在初始状态2）UE建立ECM连接来传送attach request消息给MME。ECM建立连接过程又可以分为两个子过程，1）RRC连接建立过程2）S1信令连接建立过程。</p>
<p><img src="http://img.blog.csdn.net/20150918081934764" alt="这里写图片描述"></p>
<p><strong>1）在无线连接同步之后初始状态</strong></p>
<p>为了UE请求附着到网络上，和eNB通信是必须的。所以UE通过PLMN选择和小区搜索过程选择一个eNB，并无线连接同步。接着用户可以和eNB通信了。在这个时候，UE是EMM-deregistered ECM-idle/rrc-idle状态。</p>
<p><strong>2）ECM连接建立</strong></p>
<p>在NAS层上，UE发送attach request消息（包含IMSI和UE网络能力信息）给MME的NAS层来请求初始附着。<br>为了能使attach request消息传输，在UE和MME之间的ECM连接时需要的。对于ECM连接，包含UE和eNB之间的RRC连接，eNB和MME之间的S1信令连接。NAS消息发送首先作为RRC消息通过RRC连接传输，然后通过S1信令连接作为S1AP消息传送（initial UE message初始UE消息）。</p>
<p><strong>（1）RRC连接建立</strong><br>RRC连接时建立在UE和eNB的RRC层之间的。一旦建立完成，在控制面传输消息到RRC层或者上层（NAS层）时使用RRC连接。建立RRC连接的过程如下所示：</p>
<p>1) [UE -&gt; eNB] RRC Connection Request<br>UE通过发送RRC connection request消息给eNB来请求RRC连接。当UE请求attach，detach，TAU时都是用“Mobile Originating Signaling”，它是一个值，包含在Establishment Cause域。这个消息通过SRB0，CCCH，逻辑信道由UE发送给eNB。SRB0可以被这个小区的所有UE使用。</p>
<p>2) [UE &lt;- eNB] RRC Connection Setup<br>eNB通过发送给UE RRC connection setup消息来为UE分配专有SRB1，这个消息是通过SRB0 CCCH传输的。UE的上行和下行无线资源是由eNB控制的。所以当完成这一步之后，UE通过使用RRC connection setup消息分配的SRB配置信息来使用无线资源。然后UE转到到EMM-deregistered ECM-idle RRC-connected状态。</p>
<p>3) [UE -&gt; eNB] RRC Connection Setup Complete<br>UE通过使用SRB1 DCCH发送RRC connection setup complete消息通知eNB RRC连接建立完成了。为了有效的传输，当RRC Connection Setup Complete消息传输时，传输到NAS层的attach request消息也被发送到eNB（嵌入到RRC Connection Setup Complete消息的专用NAS信息域DedicatedInfoNAS）。</p>
<p><strong>（2）S1信令连接建立</strong></p>
<p>在eNB和MME之间的控制信息时通过S1-MME接口嵌入到S1AP消息中发送的。S1AP消息是通过为他们专有建立的S1信令连接来传送的。S1信令连接使用eNB和MME分配的ID对（eNB UE S1AP ID, MME UE S1AP ID）来定义标示UE。</p>
<p>在图2中，第一个NAS消息attach request消息在S1信令连接建立之前到达eNB。 eNB接着分配eNB UE S1AP ID用于S1信令连接的建立，并发送给MME attach request消息，嵌入到initial UE message中。attach request消息嵌入到initial UE message消息的NAS-PDU域。这个initial UE message消息包含以下信息字段：</p>
<p>Initial UE Message (eNB UE S1AP ID, NAS-PDU, TAI, ECGI, RRC Establishment Cause)</p>
<ul>
<li>eNB UE S1AP ID: 在S1-MME接口上(Uplink)在eNB中标识UE</li>
<li>NAS-PDU: a NAS message (Attach Request)</li>
<li>TAI: 标识UE待在的TA</li>
<li>ECGI: 标识UE待在的小区</li>
<li>RRC Establishment Cause = mo-Signaling: 标识这个信令是UE产生的</li>
</ul>
<p>当MME在S1-MME接口从eNB接收到这个initial UE message消息，MME为UE分配一个 MME S1AP UE ID。现在有了新分配的这个ID和之前分配的eNB UE S1AP ID，在这两个实体间的S1信令连接建立起来了。接下来MME S1AP UE ID会用于在S1-MME接口（下行）上MME标识UE。</p>
<p><strong>（3）ECM S1连接建立</strong></p>
<p>通过步骤（1）（2），在UE和MME的NAS层之前的ECM连接建立起来了。接着UE转移到EMM-registered ECM-connected RRC-connected状态。</p>
<p><strong>（4）IMSI获取</strong></p>
<p>MME的NAS层从UE的NAS发送的attach request消息中获取的UE的IMSI，通过UE的网络能力信息可以知道UE使用的安全算法和安全能力。</p>
<p>在从attach request消息中获取UE的IMSI和安全能力信息之后，MME执行鉴权和NAS安全建立过程用于NAS消息的安全传输（根据EPS AKA过程使用收集到的信息）。这两个过程–鉴权和NAS安全建立–是在2.2和2.3节描述。我们已经在LTE安全文档中详细介绍了，在这里我们将简单介绍一下。</p>
<h2 id="2-2-鉴权"><a href="#2-2-鉴权" class="headerlink" title="2.2 鉴权"></a>2.2 鉴权</h2><p>图3描述了UE和MME之间的鉴权过程。这个过程包含两部分，1）鉴权向量获取，MME从HSS获取鉴权向量，2）相互鉴权。在第一步中是在MME和HSS之间S6a接口使用Diameter协议来执行。第二步在UE和MME之间使用NAS协议执行。</p>
<p><img src="http://img.blog.csdn.net/20150918103141047" alt="这里写图片描述"></p>
<p><strong>（1）鉴权向量的获取</strong><br>1）【MME-&gt;HSS】authentication information Request<br>MME向HSS发送authentication information Request消息，请求鉴权向量AV。这时候，在这个消息中包含UE的SN ID（服务网络ID）和IMSI，确保HSS返回的是UE当前服务网络信息。authentication information Request消息的主要参数包括：</p>
<p>Authentication Information Request (IMSI, SN ID)</p>
<ul>
<li>IMSI: Subscriber identifier (a fixed value provisioned at HSS for a UE)</li>
<li>SN ID: indicates the serving network of a subscriber, and consists of an PLMN ID (MCC+MNC)</li>
</ul>
<p>2）【HSS】产生鉴权向量<br>HSS使用在IMSI中的LTE K和SN ID来生成鉴权向量。鉴权向量生成包含下面两步：第一，HSS生成SQN和RAND，接着在加密函数中输入{LTE K,<br>SQN, RAND} 生成了{XRES, AUTN, CK, IK}. 接着在秘钥生成函数中输入 {SQN, SN ID, CK, IK} 生成KASME。</p>
<p><img src="http://img.blog.csdn.net/20150919082513160" alt="这里写图片描述"></p>
<p>鉴权向量的最终格式是{RAND, AUTN, XRES, KASME}, 每一个鉴权向量单元的角色如下：</p>
<p>Authentication Vectors (RAND, AUTN, XRES, KASME)</p>
<ul>
<li>RAND: HSS生成的随机数，并发送至UE。UE使用它来生成自己的鉴权向量</li>
<li>AUTN: HSS生成的鉴权令牌，并发送至UE，UE在生成自己的鉴权向量之后，和自己对比的鉴权令牌来鉴权网络</li>
<li>XRES: HSS生成的值。MME保留这个值而不发送给UE，接着MME和UE发过来的RES对比来鉴权用户。</li>
<li>KASME: 接入网络的顶层秘钥，由UE和HSS生成，并由HSS发送至MME。它作为MME和UE的基本秘钥用来生成NAS安全秘钥。</li>
</ul>
<p>3）【MME&lt;-HSS】传输鉴权向量<br>HSS在authentication information Response消息中包含鉴权向量发送给MME。MME接着使用这些信息和UE相互鉴权。</p>
<p><strong>（2）相互鉴权</strong><br>LTE需要相互鉴权。用户必须鉴权网络，网络必须鉴权用户。一旦MME从HSS接收到鉴权向量{RAND, AUTN, XRES, KASME}，它把RAND和AUTN发送给UE，UE使用它们来生成鉴权向量，并鉴权网络。MME保留着XRES, KASME用来用户鉴权和NAS安全秘钥生成。KASME是不会传输UE的。但是KASME的索引KSI-ASME是传输给UE的。相互鉴权过程如下：</p>
<p>4）【UE&lt;-MME】MME请求用户鉴权<br>MME传输authentication Request消息（RAND, AUTN, KSIASME）给UE。</p>
<p>5）【UE】用户鉴权网络：生成鉴权向量并鉴权网络<br>一旦接收到authentication Request消息（RAND, AUTN, KSI-ASME），UE首先从AUTN中生成SQN，接着像图4HSS那样生成鉴权向量。接着UE对比自己生成的AUTN-UE和接收到的AUTN来鉴权网络。并存储 KSI-ASME作为K-ASME的索引。</p>
<p>6）【UE-&gt;MME】用户的RES传输给MME<br>通过对比AUTN，用户完成网络鉴权之后，UE发送自己生成的RES到MME，包含在authentication Response消息中。这样MME就可以鉴权用户了。</p>
<p>7）【MME】网络鉴权UE<br>一旦接收到authentication Response消息，MME对比UE发过来的RES和从HSS接收到的XRES来鉴权用户。</p>
<p>一旦上述步骤完成后，UE和网络就完成了相互鉴权。现在将开始建立NAS安全。</p>
<h2 id="2-3-NAS安全建立"><a href="#2-3-NAS安全建立" class="headerlink" title="2.3 NAS安全建立"></a>2.3 NAS安全建立</h2><p>一旦用户鉴权完成，MME发起NAS安全建立过程为了NAS消息可以安全的传输。图5展示NAS安全建立过程的流程。</p>
<p><img src="http://img.blog.csdn.net/20150919084545483" alt="这里写图片描述"></p>
<p>1）【MME】生成NAS安全秘钥<br>MME从attach Request消息中选择应用于NAS消息的加密和完整性算法。接着，从K-ASME中生成NAS完整性秘钥和NAS加密秘钥K-NASint/K-NASenc，应用于NAS消息。</p>
<p>2）【UE&lt;-MME】帮助UE生成NAS安全秘钥<br>MME通过Security mode command消息(KSIASME, Security Algorithm, NAS-MAC)通知给UE选择的加密算法，帮助UE生成NAS安全秘钥。这个消息时包含NAS-MAC完整性保护的。</p>
<p>3）【UE】产生NAS安全秘钥</p>
<p>当UE收到Security mode command消息，UE通过使用MME选择的NAS安全算法来生成NAS安全秘钥(KNASint and KNASenc)。并通过NAS完整性秘钥(KNASint)来对Security mode command消息进行完整性检查。如果完整性检查通过，表示NAS安全秘钥成功设置并工作正常。</p>
<p>4）【UE-&gt;MME】NAS安全秘钥生成完毕<br>UE通过发送Security mode complete消息通知给MME NAS安全秘钥成功生成，接着可以使用生成的秘钥来加密和完整性保护。</p>
<p>在完整上述步骤之后，NAS安全建立过程结束。接着来UE和MME之间的消息都是安全传输的（使用加密和完整性保护）。</p>
<h2 id="2-4-位置更新"><a href="#2-4-位置更新" class="headerlink" title="2.4 位置更新"></a>2.4 位置更新</h2><p>一旦完成鉴权和NAS安全建立过程，MME需要注册签约用户，并找出来签约用户使用的服务。MME通知HSS签约用户已经注册了并驻留在它的TA，接着从HSS下载签约用户信息。所有这些过程都是通过MME和HSS之间S6a接口的Diameter协议来执行位置更新过程来完成的。具体过程如图6所示。</p>
<p><img src="http://img.blog.csdn.net/20150919090030241" alt="这里写图片描述"></p>
<p>1）【MME-&gt;HSS】通告UE位置<br>MME向HSS发送update location Request（IMSI，MME ID）消息为了通告UE的注册和获取UE的签约信息。</p>
<p>2）【HSS】UE位置更新<br>HSS注册MME ID来指示UE驻留的哪个MME。</p>
<p>3）【MME&lt;-HSS】用户签约信息的传输<br>HSS把用户的签约信息包含在update location answer消息中发送给MME，MME创建这个签约用户的EPS会话和默认EPS承载。包含在update location answer消息中的签约信息如下：</p>
<p>Update Location Answer (IMSI, Subscribed APN, Subscribed P-GW ID, Subscribed QoS Profile)</p>
<ul>
<li>Subscribed APN: 用户签约的APN (e.g. Internet service)</li>
<li>Subscribed P-GW ID: 用户接入签约APN通过的那个PGW的ID</li>
<li>Subscribed QoS Profile(UE-AMBR(UL/DL), QCI, ARP, APN-AMBR(UL/DL))<ul>
<li>UE-AMBR (UL/DL): MME决定和eNB控制的UE具有所有的nonGBR承载的聚合带宽</li>
<li>QCI, ARP, APN-AMBR (UL/DL): 应用于签约APN的QoS</li>
</ul>
</li>
</ul>
<p>4）【MME】存储签约信息<br>MME从HSS接收到update location answer消息后，存储这个消息中的签约信息。</p>
<p>从下载的签约信息，MME可以检查用户签约的服务，使用什么QoS级别的资源来连接到哪个APN。</p>
<h2 id="2-5-EPS会话建立"><a href="#2-5-EPS会话建立" class="headerlink" title="2.5 EPS会话建立"></a>2.5 EPS会话建立</h2><p>MME基于签约信息建立EPS会话和默认EPS承载。MME为每一个用户提供满足用户签约QoS的网络/无线资源。图7/8描述了EPS会话和默认EPS承载建立过程。</p>
<p><img src="http://img.blog.csdn.net/20150919092612216" alt="这里写图片描述"></p>
<p>1）【MME】分配EPS承载ID<br>MME从5-15选择一个值，分配作为EPS承载ID（EBI）来为新附着的用户连接默认EPS承载。</p>
<p>2）【MME】选择PGW<br>MME检查从HSS接收到的APN，并决定使用哪个PGW来接入这个APN。这个决定是基于从HSS接收到的签约信息（PGW ID）。或者如果没有这些信息，MME请求DNS服务器获得APN FQDN(e.g. internet.apn.epc.mnc05.mcc450.3gppnetwork.org), 并从按照PGW选择策略返回的PGW IP地址列表中选择一个。这时候，也需要选择一个SGW来到达PGW。</p>
<p>3）~4）请求EPS会话创建<br>MME通过给PGW发送create session Request消息来请求EPS会话和默认EPS承载的创建。在这个消息中，MME包含从HSS接收到的用户签约信息，当请求PCRF创建EPS会话时，PGW可以使用这些信息。这时候，UE-AMBR还没有包含，因为它是由MME决定的。</p>
<p>3）【MME-&gt;SGW】请求EPS会话创建<br>MME和SGW在控制面使用GTP协议在S11接口上通信。MME发送给第二步选择的SGW create session Request消息，包含以下参数：</p>
<p>Create Session Request (IMSI, EPS Bearer ID, P-GW IP, APN, Subscribed Profile (QCI, ARP, APNAMBR (UL/DL)), ECGI, TAI)</p>
<ul>
<li>IMSI: 固定的用户ID</li>
<li>EPS Bearer ID: 由MME分配的默认EPS承载ID</li>
<li>P-GW IP: MME选择用于EPS会话/承载创建的PGW IP地址</li>
<li>APN: 用户签约的APN</li>
<li>Subscribed Profile (QCI, ARP, APN-AMBR (UL/DL)): 建立默认EPS承载时使用的QoS信息</li>
<li>ECGI: 用户驻留的小区</li>
<li>TAI: 用户驻留的TA</li>
</ul>
<p>4）【SGW-&gt;PGW】请求EPS会话的创建<br>SGW和PGW在S5接口上用户面和控制面使用GTP（UP：GTP-U，CP：GTP-C）协议通信。SGW在create session Request消息中分配S5 TEID来建立到PGW的S5 GTP。接着在create session request消息中发送这个ID和其他参数给PGW。</p>
<p>Create Session Request (IMSI, EPS Bearer ID, S5 S-GW TEID, APN, Subscribed Profile (QCI, ARP, APN- AMBR (UL/DL)), ECGI, TAI)</p>
<p>5）【S5 承载：下行】<br>一旦4）完成之后，下行S5 GTP-U隧道就建立起来了，允许PGW发送下行流量给SGW。在图7和8中，分配和发送GTP隧道TEID的实体被标记为实点，接收的一个被标记为虚点。</p>
<p>6）【PGW】分配用户IP地址<br>PGW一旦接收到create session request消息，意识到用户试图通过IMSI接入网络。所以PGW给UE分配IP地址，让UE可以使用IP。</p>
<p>7）【PGW-&gt;PCRF】通知EPS会话建立<br>PGW和PCRF通过Gx接口使用Diameter协议通信。当创建了用户的EPS会话，用户的资源配置和QoS控制都必须基于用户订阅的服务来决定。PCRF负责所有接入网络UE的接入策略。所以，PGW提供给PCRF用户的签约信息，并获取资源分配和网络运营商策略的PCRF授权。从UE的签约信息（从MME接收到的），PGW获取用于PCRF运营商策略决策制定的信息，并通过CCR消息（CC-request）发送这些信息给PCRF。这个消息实例如下：<br>CCR (IMSI, UE IP, PDN ID (APN), Subscribed QoS Profile (QCI, ARP, APN-AMBR (UL/DL)), ECGI,TAI)：</p>
<ul>
<li>IMSI: 固定的用户ID</li>
<li>UE IP: 正在服务中的用户使用的IP地址</li>
<li>PDN ID: 用户使用的APN</li>
<li>Subscribed Profile (QCI, ARP, APN-AMBR (UL/DL)): 建立默认EPS承载时应用的QoS信息</li>
<li>ECGI: UE驻留的小区</li>
<li>TAI: UE驻留的TA</li>
</ul>
<p>8）【PCRF-&gt;SPR】请求接入配置<br>PCRF向SPR请求用户接入配置文件来决定用户的PCC策略</p>
<p>9）【PCRF&lt;-SPR】返回接入配置<br>SPR返回用户的接入配置文件。这个配置文件包含的信息例如，SDF Filter, QCI, ARP, APN-AMBR (UL/DL), Charging Method (e.g. Offline), Changing Reporting Action (e.g. Start Reporting ECGI, TAI),等等</p>
<p>10）【PCRF】决定策略<br>PCRF决定EPS会话建立（基于用户接入配置文件）的PCC策略。</p>
<p>11）【PGW&lt;-PCRF】确认EPS会话建立<br>PCRF传输决定好的PCC策略给PGW，包含在CCA（CC-answer）消息中。这个消息的实例如下：<br>CCA (IMSI, PCC Rule (SDF Filter, QCI, ARP, APN-AMBR (UL/DL), Charging=Offline, Change Reporting Action (Start Reporting ECGI, TAI))</p>
<p>12）策略实施<br>PGW应用从PCRF接收到的PCC策略。PCC策略应用到每一个SDF上，所以PGW需要建立SDF和EPS承载之间的映射，并准备应用QoS配置文件到默认EPS承载上。</p>
<p>13）~15）EPS session create response<br>PGW通过发送create session response消息通知MME，应用于建立EPS会话和默认EPS承载的QoS信息。PCRF可能会保存这个从HSS接收到的值或者选择一个新的值。</p>
<p>13）【SGW&lt;-PGW】EPS session response<br>PGW为建立到SGW的S5 GTP分配S5 TEID。接着在create session response消息中包含S5 PGW TEID和QoS配置文件应用于默认EPS承载，并发送给SGW作为对create session request消息的响应。<br>Create Session Response (UE IP, EPS Bearer ID, S5 P-GW TEID, Authorized QoS Profile (QCI, ARP,APN-AMBR (UL/DL)), TFT (UL), Change Reporting Action (Start Reporting ECGI, TAI))</p>
<p>14）【S5承载：上行】S5承载建立<br>在完成13）之后建立了上行S5 GTP-U隧道，允许SGW和PGW剑豪上下行流量。</p>
<p>15）【MME&lt;-SGW】EPS session create response<br>当从PGW接收到create session response消息后，SGW保留上行S5 TEID用于上行流量，并允许S1GTP 隧道的S1 TEID用于S1承载。在处理完这个消息后，SGW在处理完的消息上加入新分配的S1 SGW TEID，然后发送到MME，作为对3）的create session request的响应。</p>
<p>16）【MME】为什么MME保留S5 PGW TEID<br>一旦附着到网络，如果UE执行TAU或者切换，SGW可能发生改变。所以MME通知UE新SGW的上行S5 TEID，这样新SGW可以传输上行流量给PGW。</p>
<p>17）【S1承载：上行】<br>完成15）之后建立了上行S1 GTP隧道。但是因为eNB还没有S1 SGW TEID，所以这是还不能给SGW传输上行流量。</p>
<p>18）【MME】计算ue-ambr<br>这时候，MME返回给attach accept消息给UE作为对attach request消息的响应，并通过控制eNB来转呗e-rab建立（eg，为无线链路和S1承载分配资源）。MME计算ue-ambr值发送给eNB。MME已经接收到ue-ambr值，包含在签约信息中。但是MME可以调整这个值，使之不超过每一个APN的全部apn-ambr，并分配它。</p>
<p><img src="http://img.blog.csdn.net/20150921120911922" alt="这里写图片描述"></p>
<p>19）决定E-rab和NAS信令需要的信息<br>在从PGW接收到create session response消息之后，MME知道已经指定和分配给用户的资源。接着，MME负责E-RAB的建立，并控制eNB和SGW。最后，MME决定E-RAB建立所需要的资源和NAS信令需要的信息：</p>
<ul>
<li>分配给UE GUTI代替IMSI</li>
<li>决定和控制TAU相关的参数（TAI列表分配，tau定时器值）</li>
<li>决定eNB使用的ue-ambr值</li>
<li>分配e-rab ID</li>
</ul>
<p>20）【UE&lt;-MME】attach accept<br>MME在attach accept消息中包含下面信息：PGW分配的UE IP地址，GUTI，TAI list，EPS  bearer ID，MME自己分配的UE-AMBR，从SGW接收到的QoS参数，并发送给UE作为对attach request的响应。<br>这个消息是包含在initial context setup request消息中通过S1信令连接传送的，接着通过RRC连接包含在RRC connection reconfiguration消息中。</p>
<p>21）【MME】生成K-eNB<br>MME从K-asme中生成K-enb，（AS安全基础秘钥）。这是为了确保eNB可以生成AS安全秘钥用于eNB和UE之间无线链路的安全传输。</p>
<p>22）【eNB&lt;-MME】请求e-rab建立<br>MME发送initial context setup request消息，接着eNB和SGW建立起S1承载，和UE建立起DRB承载。这个消息包含以下信息：<br>Initial Context Setup Request (UE-AMBR (UL/DL), E-RAB ID, E-RAB QoS (QCI, ARP), S1 S-GW TEID,KeNB, , UE Security Algorithm, NAS-PDU)：</p>
<ul>
<li>UE-AMBR(UL/DL):只能被eNB控制的QoS参数</li>
<li>E-RAB ID: 由MME分配，并由eNB作为EPS bearer ID使用</li>
<li>E-RAB QoS: 由MME以及与从PGW接收到的EPS bearer QoS来决定</li>
<li>S1 S-GW TEID: 从SGW接收到的上行S1 TEID</li>
<li>KeNB: 由MME从Kasme生成的，用于eNB中AS安全秘钥的生成</li>
<li>UE Security Algorithm: 包含在Attach Request消息中，和KeNB一起用来eNB建立AS安全</li>
<li>NAS-PDU: NAS消息 (Attach Accept)</li>
</ul>
<p>23) [S1 承载: 上行]<br>一旦22）完成，获得了S1 SGW TEID，eNB可以传输上行流量到SGW。当eNB接收到MME的Initial Context Setup Request消息来请求E-RAB建立，eNB通过发送attach accept消息给UE来建立DRB。接着eNB在Initial Context Setup Response消息中包含下行S1 TEID来建立S1承载，并发送Initial Context Setup Response消息到MME来作为Initial Context Setup request消息的响应，所以MME可以转发这个消息给SGW。</p>
<p>24) ~ 27) AS安全建立<br>一旦接收到MME的initial context setup request消息，eNB试图和UE通信建立DRB。为了在无线链路上安全的通信，eNB在发送信息给UE之间需要执行AS安全建立过程。</p>
<p>24) [eNB] 产生AS安全秘钥<br>eNB从KeNB中生成AS安全秘钥用于RRC消息和用户流量的安全传输。eNB从MME传输过来的安全算法中为RRC消息选择加密和完整性算法，并未用户流量选择加密算法。接着，从K-eNB中生成KRRCint/KRRCenc（RRC完整性和加密秘钥）和KUPenc（用于用户数据的加密）。</p>
<p>25) [UE &lt;- eNB] 帮助UE生成AS安全秘钥<br>eNB通过通知给UE选择的AS安全算法来帮助UE生成AS安全秘钥 (KRRCint, KRRCenc and KUPenc)，（使用Security Mode Command(AS Security Algorithm, MAC-I)消息来传输）。eNB发送完整性保护的RRC消息，（包含mac-I）.</p>
<p>26) [UE] 生成AS加密秘钥<br>一旦接受到Security Mode Command 消息，UE通过使用eNB选择的AS安全算法来生成AS安全秘钥，并执行Security Mode Command 消息的完整性检查。</p>
<p>27) [UE -&gt; eNB] AS秘钥生成完成<br>一旦完成对Security Mode Command 消息的完整性检查，AS安全秘钥被成功的建立起来，并准备在UE和eNB之间使用。UE通过使用Security Mode complete (MAC-I) 消息指示eNB AS安全秘钥已经产生。UE使用RRC完整性秘钥来对发送的消息进行完整性保护。随着在无线链路接上AS安全建立过程结束，在随后的无线连接上的RRC消息交换都是加密和完整性保护的，并用户消息是加密传送的。现在eNB开始建立DRB</p>
<p>28) ~ 29) DRB建立<br>28) [UE &lt;- eNB] 重配RRC连接<br>eNB分配上下行 DRB ID，并从E-RAB QoS中配置DRB QoS参数来建立无线连接的DRB。接着通过安全的RRC连接发送RRC connection reconfiguration消息给UE。RRC连接上在UE发送attach request消息时建立。现在RRC连接必须重配，因为UE被允许接入网络后需要根据网络分配的资源来配置参数。UE的RRC层根据RRC connection reconfiguration消息中的配置参数来分配无线资源。接着从RRC connection reconfiguration中提取attach accept消息，并发送到NAS层。当UE的NAS层接收到这个消息，从这个消息中蝴蝶UE IP地址和GUTI，用于接下来的通信需要。</p>
<p>29) [DRB 建立: 上行和下行] DRB建立完成<br>一旦28）完成后，UE可以和eNB之间传输上下行数据。</p>
<p>30) [eNB -&gt; S-GW] E-RAB Setup Response<br>eNB为S1承载分配下行S1 TEID (S1 eNB TEID) 。接着在 Initial Context Setup Response消息中包含分配的ID发送给MME，作为 Initial Context Setup request消息的响应，接着MME把这个消息转发给SGW。</p>
<p>31) [eNB] 为S1承载分配下行TEID<br>一旦29）完成后，eNB为S1承载分配了下行TEID，建立下行S1 GTP-U隧道。因为SGW并不知道是否建立，现在它还不能传输下行数据到eNB。</p>
<p>32) [UE -&gt; MME] 发送Attach Complete 消息<br>UE发送Attach Complete消息给MME作为20）的消息的响应。Attach Complete消息是在RRC连接上通过UL Information Transfer消息，在S1信令连接上通过Uplink NAS Transport 消息传输的。</p>
<p>33) [UE][MME] EMM State<br>现在UE和MME处于EMM-Registered状态。如果在20）从MME接收到的是Attach Reject消息，UE必须释放ECM/RRC连接，并且转移到EMM-deregistered状态。</p>
<p>34) [MME -&gt; S-GW] 请求S1承载修改<br>MME通过Modify Bearer Request消息转发从eNB接收到的下行S1 TEID(S1 eNB TEID)给SGW。</p>
<p>35) [MME &lt;- S-GW] 响应S1 Bearer Modification Request<br>SGW发送给MME Modify Bearer Response消息作为对Modify Bearer Request消息的响应。现在SGW准备传输下行S1数据。</p>
<p>36) [S1 Bearer: Downlink] S1 Bearer Setup Complete<br>在35）完成S1承载建立过程。随着S1承载建立的完成，eNB和SGW可以相互交换数据了。现在从UE一直到PGW的默认承载终于建立起来了，允许在UE和PGW之间传输上下行EPS承载通信。</p>
<h1 id="III-EPS-Entity-Information-Before-After-Initial-Attach"><a href="#III-EPS-Entity-Information-Before-After-Initial-Attach" class="headerlink" title="III. EPS Entity Information: Before/After Initial Attach"></a>III. EPS Entity Information: Before/After Initial Attach</h1><p>在这一章，我们将讨论在“EMM Case 1: Initial Attach by Unknown UE”过程前后EPS实体的EMM状态的变化。存储在EPS实体中的信息将会被分组给UE ID信息，UE 位置信息，安全上下文信息，安全上下文信息，EPS会话/承载信息，如图9所示。</p>
<p><img src="http://img.blog.csdn.net/20150921153019850" alt="这里写图片描述"></p>
<h2 id="3-1-Initial-Attach之前"><a href="#3-1-Initial-Attach之前" class="headerlink" title="3.1 Initial Attach之前"></a>3.1 Initial Attach之前</h2><p>图10描述了在“EMM Case 1: Initial Attach by Unknown UE”过程之前每一个实体中的信息。因为EMM case-1是未知用户的初始附着，所以仅包含网络提供的信息。</p>
<p><img src="http://img.blog.csdn.net/20150921153050505" alt="这里写图片描述"></p>
<ul>
<li>UE ID information: 在UE, HSS and SPR.中提供的用户的IMSI。</li>
<li>UE Location information: 在UE和网络都没有任何关于UE位置的信息。</li>
<li>Security Context information: 在UE and HSS提供了用于用户鉴权的LTE 主秘钥</li>
<li>EPS Session/Bearer information: 用户签约信息 (Default APN, Subscribed QCI, ARP,UE-AMBR, APN-AMBR, etc.) 和用户接入配置 (Subscribed QCI, ARP, APN-AMBR, etc.)在HSS and SPR中提供。</li>
</ul>
<h2 id="3-2-Initial-Attach之后"><a href="#3-2-Initial-Attach之后" class="headerlink" title="3.2 Initial Attach之后"></a>3.2 Initial Attach之后</h2><p>图11描述了在“EMM Case 1: Initial Attach by Unknown UE”过程之后EPS实体中存储的信息。因为用户已经注册到网络上，所有必要的信息都分配了，信息（用于UE安全接收用户数据和用于在任何设定的位置以想要的服务质量使用服务的信息）都分配了。我们将学习在initial attach之后什么信息发生了变化。</p>
<p><img src="http://img.blog.csdn.net/20150921153154280" alt="这里写图片描述"></p>
<p>UE ID Information的变化</p>
<ul>
<li>IMSI: 在EPS承载/会话建立之后，由UE通过attach request消息传输的IMSI被加入到MME, SGW, P-GW and PCRF。</li>
<li>GUTI: 在NAS消息中使用由MME分配的用来代替IMSI的GUTI加入到MME和UE.</li>
<li>UE IP address: PGW分配的UE IP地址被加入到P-GW, PCRF, MME and UE.</li>
<li>C-RNTI: eNB分配的C-RNTI 用来空中接口物理层识别UE被加入到到eNB和UE.</li>
<li>UE S1AP ID: eNB UE S1AP ID和MME UE S1AP ID接入到eNB和MME用来S1-MME接口S1AP消息中标识用户。</li>
</ul>
<p>UE Location Information的变化</p>
<ul>
<li>ECGI: 用户驻留小区信息加入到UE, eNB, MME, S-GW, P-GW and PCRF. 每次用户移动到一个新小区，MME通知PGW，接着通知PCRF，用PCRF设定的Change Reporting Action策略通知小区。</li>
<li>TAI: 用户驻留的TA加入到UE, eNB, MME, S-GW, P-GW and PCRF. 每次用户移动到一个新的TA，MME通知PGW，接着通知PCRF，用PCRF设定的Change Reporting Action策略通知TA。</li>
<li>TAI list: UE不需要tau就可以进入的TA列表加入到MME和UE</li>
<li>MME ID: 用户附着打MME信息加入到HSS中</li>
</ul>
<p>Security Context Information的改变</p>
<ul>
<li>NAS Security Info: NAS安全上下文信息加入到UE和MME中</li>
<li>AS Security Info: AS安全上下文加入到UE和eNB中</li>
</ul>
<p>EPS Session/Bearer Information的改变</p>
<ul>
<li>APN in Use: 在EPS会话创建时加入到MME, S-GW, P-GW, PCRF and UE </li>
<li>EPS Bearer ID: 加入到MME和默认承载创建的实体，像UE, eNB, S-GW and P-GW.</li>
<li>DRB ID: 加入到UE 和eNB使之能在无线连接上通信</li>
<li>E-RAB ID: 在E-RAB创建时加入到eNB和MME中</li>
<li>S1 TEID (UL/DL): 在S1承载建立时加入到eNB, S-GW and MME</li>
<li>S5 TEID (UL/DL): 在S5承载建立时加入到S-GW, P-GW and MME</li>
<li>QCI: 分配用于所有类型的SDF和EPS承载，加入到UE, eNB, MME, S-GW, P-GW and PCRF. 这个值是由PCRF提供的。</li>
<li>ARP: 分配用于所有类型的SDF和EPS承载，加入到eNB, MME, S-GW, P-GW and PCRF,但是不分配给UE(unlike QCI). 这个值是由PCRF提供的。</li>
<li>UE-AMBR (UL/DL): 在EPS会话和承载创建时加入到MME和eNB中。是由MME计算得到的。</li>
<li>APN-AMBR (UL/DL): 在EPS会话和承载创建时加入到MME和eNB中。这个值是由PCRF提供的。UE只有APN-AMBR（UL）。</li>
<li>TFT (UL/DL): 在EPS承载创建时加入到PGW和UE中。PGW上下行都有这个值，但是UE只有上行有。</li>
<li>SDF Filter: 在EPS会话创建时加入到PCRF。</li>
<li>Subscribed Profile: 在用户位置更新过程时在从HSS中下载签约信息时加入到MME中。</li>
</ul>
<h1 id="IV-Closing"><a href="#IV-Closing" class="headerlink" title="IV. Closing"></a>IV. Closing</h1><p>我们讨论了在签约服务之后第一次附着网络initial attach过程。另外，在上面的文档讨论了四种case。在接下来我们将讨论detach过程。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “Eleven EMM Cases in an EMM Scenario”, October 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002</a><br>[2] Netmanias Technical Document, “EMM Procedure 1. Initial Attach – Part 1. Cases of Initial Attach”,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6098" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6098</a><br>[3] Netmanias Technical Document, “LTE Security II: NAS and AS Security”, August 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903</a><br>[4] Netmanias Technical Document, “LTE Security I: LTE Security Concept and LTE Authentication”, July<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5902" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5902</a><br>[5] Netmanias Technical Document, “LTE QoS: SDF and EPS Bearer QoS”, September 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5908" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5908</a><br>[6] NMC Consulting Group Confidential Internal Report, “E2E LTE Network Design”, August 2010.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/10-EMM-Procedure-1-Initial-Attach-Part-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/10-EMM-Procedure-1-Initial-Attach-Part-1/" itemprop="url">10-EMM Procedure 1. Initial Attach Part-1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:19:07+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>EMM Procedure 1. Initial Attach<br>Part 1. Cases of Initial Attach</p>
<p>原文链接：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6098" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6098</a></p>
<hr>
<h1 id="I-Introduction"><a href="#I-Introduction" class="headerlink" title="I. Introduction"></a>I. Introduction</h1><p>这个文档讨论初始附着，也就是第九篇文档所讨论的case1。在这个阶段，用户在签约到一个LTE网络服务之后，用户开机，试图附着到网络上，发送IMSI给网络。<br>初始附着过程随着环境发生变化。可以是下面将要讨论的case1也可以是EMM case11（在另外一个城市初始附着，将在后面的文档中讨论）。或者可以使其他类型，取决于用户是否保存着上次附着到网络时使用的信息，（这里是指最后附着信息，或者MME是否有用户的信息，包括UE ID，接下来都是指最后一次UE上下文）。所以这个文档描述了不同初始附着类型，发现他们的特征和不同。接下来的文档part2将描述EMM case1，详细介绍相关的过程。</p>
<p>这个文档组织如下：第二章描述不同的初始附着类型，第三章通过列出MME执行的功能来简要讨论每一种情况的不同初始附着过程。</p>
<h1 id="II-Cases-of-Initial-Attach"><a href="#II-Cases-of-Initial-Attach" class="headerlink" title="II. Cases of Initial Attach"></a>II. Cases of Initial Attach</h1><p>当UE初始附着到网络，MME根据附着的类型来发起不同的过程。这个过程以attach request消息开始，以attach accept消息结束。当UE发送给MME attach request消息，在这个消息包含UE ID（IMSI or old GUTI）来识别UE。当MME发送attach accept（GUTI和TAI列表）消息，在消息中包含用来代替IMSI的ID –GUTI，和包含TAI列表（在这个区域，UE不需要TAU过程可以进入的区域）。</p>
<p>在接收到attach request消息之后，发送attach accept消息之前，MME可能执行以下过程的全部或部分：</p>
<ul>
<li>UE ID 获取</li>
<li>鉴权</li>
<li>NAS安全建立</li>
<li>位置更新</li>
<li>EPS会话建立</li>
</ul>
<p>基于UE发起的初始附着的类型，决定要执行哪些过程。但是，UE ID过去和EPS会话建立过程是所有初始附着过程都必须的。其他过程，像鉴权，NAS安全建立和位置更新更具初始附着的类型选择的执行。这些过程的选择受到下面因素的影响：i)UE有的UE ID是什么（IMSI or old GUTI），ii）上次附着信息是否依旧保存在MME中有效等等。在这个文档中，我们将使用下面的判决来分辨初始附着的不同类型，如图1所示。</p>
<ul>
<li>UE使用什么UE ID累发起初始附着请求（IMSI or old GUTI）？</li>
<li>UE尝试附着的MME是哪个（是上次附着的那个，还是从来没有附着过的一个新的）？</li>
<li>在网络中是否有有效的UE上下文存在？</li>
</ul>
<p><img src="http://img.blog.csdn.net/20150915135257809" alt="这里写图片描述"></p>
<p>在这个文档中，如果上次UE上下文（包含UE ID）在网络中不存在，UE被定义为未知UE，其他的称为已知UE。2.1节描述未知UE的初始附着，2.2节描述已知UE的初始附着。下面，如果UE有上次附着信息，我们假设attach request消息已经完整性保护的。</p>
<h2 id="2-1-未知UE"><a href="#2-1-未知UE" class="headerlink" title="2.1 未知UE"></a>2.1 未知UE</h2><p>图2描述了当UE给网络发送了attach request消息初始附着的实例，MME没有关于用户的有效的UE上下文。我们将分辨初始附着的类型，并解释每一种类型的特征比较。现在UE想附着的MME称为新MME，上次UE已经附着过的MME称为旧MME。</p>
<p><img src="http://img.blog.csdn.net/20150915135947039" alt="这里写图片描述"></p>
<p><strong>attach case-1：当UE使用IMSI来附着</strong></p>
<p>这个是在UE和MME中都没有上次UE上下文，这种情况下需要的场景如下：</p>
<p>1）UE使用IMSI作为UE ID发送给MME attach request消息。MME从这个消息中获得IMSI。<br>2）假设MME不知道UE（以为发送的而是IMSI），MME发起鉴权和NAS安全建立过程。<br>3）MME向HSS发送位置更新消息通知HSS UE已经注册上了，并从HSS中下载这个用户的签约信息。</p>
<p><strong>attach case-2：当UE附着的MME是上次已经附着的MME（new MME=old MME），但是MME没有包含有效的上次UE上下文</strong></p>
<p>这个是当UE在上次附着后仍保留着上次附着信息（old GUTI和NAS安全上下文）时UE尝试附着到相同的MME上，但是MME没有任何UE的上下文。基本的过程如下：<br>1）UE使用old GUTI给新的MME发送attach request消息。这时候，这个attach request消息是使用NAS安全秘钥（K-NASinc）完整性保护的。<br>2）因为GUTI包含GUMMEI，新的MME就可以从old GUTI中知道这个旧的GUTI是从哪里分配的。新的MME查找上次UE上下文，但是没有找到任何信息（例如，完整性验证失败或者没有old GUTI）。<br>3）MME给UE发送identity request消息来请求IMSI。<br>4）UE给MME发送identity response消息提供请求的IMSI。<br>5）现在，MME通过使用获取的IMSI按照attach case-1的流程执行鉴权和NAS安全建立过程，接着发送UE位置更新消息给HSS。</p>
<p><strong>attach case-3：当UE附着到一个之前从来没有附着过的MME上（new MME ！= old MME），且MME没有有效的上次UE上下文信息</strong></p>
<p>这是当UE在上次去附着之后仍然还保留着上次附着信息，附着到一个新的MME，不是旧的MME，但是就的MME没有和UE关联的有效的UE上下文信息。基本过程如下所示：<br>1）UE使用old GUTI作为UE ID给新的MME发送attach request消息，这时候这个消息是完整性保护的<br>2）当新的MME接收到这个消息，他从这个old GUTI知道来自哪里。<br>3）接着，新的MME向旧的MME发送identification request（old GUTI，完整的attach request消息）把旧的GUTI和attach request消息转发给旧的MME。通过这个消息，新的MME请求和旧的GUTI相关的上次UE上下文。<br>4）一旦接收到这个消息，旧MME查找UE上下文，但是没有找到任何信息。<br>5）旧MME给新MME发送identification response消息，通知没有找到UE上下文。</p>
<p>从这儿开始开始和attach case-2相同，执行attach case-2的3/4/5。新MME发送给UE identify request消息来请求IMSI。接着UE携带自己的IMSI使用identify response消息发送给MME。MME接收到IMSI后，MME开始执行鉴权和NAS安全建立和UE位置更新。</p>
<h2 id="2-2-已知UE"><a href="#2-2-已知UE" class="headerlink" title="2.2 已知UE"></a>2.2 已知UE</h2><p>图3展示了UE发送attach request初始附着到网络，并且MME有用户有效的UE上下文信息的情况。在初始附着时，不像未知UE，所有的已知UE都是使用GUTI，不是IMSI。在图3中，UE和MME中都包含和用户相关的UE上下文信息，并且UE发送的attach request消息是完整性保护的。</p>
<p><img src="http://img.blog.csdn.net/20150917152809534" alt="这里写图片描述"></p>
<p><strong>attach case-4：当UE附着到上次附着过的MME上，并且这个MME中包含用户有效的上次UE上下文</strong></p>
<p>这是当UE仍旧有上次附着信息（old GUTI，NAS安全上下文），附着到它上次附着的MME，MME具有这个UE的有效UE上下文。具体的场景如下：<br>1）UE使用old GUTI作为自己的UE ID给new MME发送attach request消息。这个attach request消息是使用NAS完整性秘钥K-NASint完整性保护的。<br>2）这个new MME从old GUTI中知道谁分配的这个ID。然后它查找old GUTI，找到有效的UE上下文（IMSI，MM上下文（NAS安全上下文，UE-AMBR））。<br>3）MME对attach request消息执行完整性检查<br>        i)如果完整性检查失败，MME必须使用IMSI来鉴权用户，并执行用户的NAS安全建立过程。<br>        ii）如果完整性检查通过，MME会略过鉴权和NAS安全建立过程。</p>
<p><strong>attach case-5：当UE附着到之前没有附着过的MME上（new MME！=old MME），并且old MME具有有效的上次UE上下文</strong></p>
<p>这是当仍包含上次附着信息，附着到一个新的MME，在旧的MME上具有有效的UE上下文。一个简单过程如下：<br>1）UE使用old GUTI作为自己的UE ID给new MME发送attach request消息。这个attach request消息是完整性保护的。<br>2）new MME从接收到的old GUTI上知道是谁分配的（old MME）。<br>3）new MME向old MME发送identification request（old GUTI，完整的attach request消息），转发old GUTI和attach request消息。通过这样，new MME请求和old GUTI相关联的上次UE上下文信息。<br>4）一旦接收到这个消息，old MME查找UE上下文，找到和这个UE相关联的IMSI和MM上下文（NAS安全上下文，UE-AMBR）。<br>5）old MME对attach request消息执行完整性检查<br>6）old MME把完整性检查的结果通过identification response消息发给new MME<br>        i)如果完整性检查失败，old MME在这个消息转发错误原因消息。<br>        ii）如果完整性检查通过，则转发UE上下文（IMSI，old GUTI，MM上下文）。</p>
<p>如果完整性检查失败，情况和attach case-3相同，因此需要执行和attach case-3上相同的IMSI获取，鉴权和NAS安全建立过程。如果检查通过，new MME从old MME接收到IMSI和MM上下文，并略去鉴权和NAS安全建立的过程（类似case-4）。和case-4不同的一点就是因为UE是附着到一个new MME，这个new MME需要和HSS通信更新UE的位置信息。</p>
<h1 id="III-Simplified-Call-Flow-in-Each-Case"><a href="#III-Simplified-Call-Flow-in-Each-Case" class="headerlink" title="III. Simplified Call Flow in Each Case"></a>III. Simplified Call Flow in Each Case</h1><p>第二章介绍了不同类型的初始附着。第三章将描述在每种类型的流程，主要关注在功能模块上。图4描述了基于使用不同的UE ID，每一个初始附着过程具有不同的流程。对于known UE的初始附着情况，我们讨论NAS-MAC完整性检查在什么地方完整。在初始附着过程中执行的功能模块包括：</p>
<p>1）UE ID获取<br>MME获取去UE ID用于用户身份认证和鉴权。UE ID可以是IMSI和old GUTI。IMSI可以通过attach request或者iDentify response消息从UE中获取，而old GUTI可以通过attach request消息从UE中获取。</p>
<p>2）鉴权<br>如果MME通过attach request消息获取IMSI或者old GUTI作为UE ID，但是这个消息的完整性检查失败了，网络检查是否需要通过执行EPS AKA过程来允许UE附着。通过产生鉴权向量并发送到MME，HSS产生K-ASME（MME基本秘钥），接着和UE之间执行相互鉴权。</p>
<p>3） NAS安全建立<br>一旦用户鉴权完成，产生了在UE和MME之间用于NAS消息安全传输的NAS安全秘钥。</p>
<p>4）位置更新<br>MME从HSS下载用户信息，并且HSS更新UE当前位置的信息。MME只有当i)UE使用IMSI作为UE ID时ii）MME没有有效的上次UE上下文信息iii）MME没有关于用户的任何签约信息iv）UE上次从其他MME上去附着，这些情况下MME才会执行位置更新。</p>
<p>5）EPS会话建立<br>EPS会话和默认承载建立。</p>
<p><img src="http://img.blog.csdn.net/20150917162518218" alt="这里写图片描述"></p>
<h2 id="3-1-使用IMSI初始附着"><a href="#3-1-使用IMSI初始附着" class="headerlink" title="3.1 使用IMSI初始附着"></a>3.1 使用IMSI初始附着</h2><p><strong>attach case-1：unknown UE</strong></p>
<p>UE使用IMSI请求初始附着，MME从attach  request消息中获取用户的IMSI。</p>
<p>【UE-&gt;MME】attach request（IMSI）</p>
<p>在初始附着时UE如果使用IMSI，MME会执行鉴权，NAS安全建立和位置更新，建立EPS会话/默认EPS承载。</p>
<h2 id="3-2-使用GUTI初始附着"><a href="#3-2-使用GUTI初始附着" class="headerlink" title="3.2 使用GUTI初始附着"></a>3.2 使用GUTI初始附着</h2><p><strong>attach case-2：unknown UE，MME unchanged</strong></p>
<p>UE使用old GUTI请求初始附着，但是MME中没有old GUTI。所以MME向UE请求UE ID，并获取IMSI。</p>
<p>【UE-&gt;MME】 attach request（old GUTI）<br>【MME】 no IMSI<br>【UE&lt;-MME】 identity request（UE ID=IMSI）<br>【UE-&gt;MME】identity response（IMSI）</p>
<p>剩下来的过程和case-1相同。也就是，MME执行鉴权，NAS安全建立，位置更新和建立EPS会话/默认EPS承载。</p>
<p><strong>attach case-3：unknown UE，MME changed</strong></p>
<p>UE使用old GUTI请求初始附着。所以，new MME向old MME请求上次UE上下文，但是没有接收到任何有效的。所以MME向UE请求UE ID，获取IMSI。</p>
<p>【UE-&gt;new MME】 attach request（old GUTI）<br>【new MME-&gt;old MME】identification request(old GUTI)<br>【old MME】no IMSI<br>【new MME&lt;-old MME】identification response（error cause）<br>【UE<-new mme】identity="" request="" （ue="" id="IMSI）" 【ue-="">new MME】identify response（IMSI）</-new></p>
<p>剩下的过程和case-1相同。也就是，MME执行鉴权，NAS安全建立，位置更新和建立EPS会话/默认EPS承载。</p>
<p><strong>attach case-4： known UE， MME unchanged</strong></p>
<p>UE使用old GUTI请求初始附着，MME有和old GUTI相关的上次UE上下文。所以不需要获取IMSI的步骤。</p>
<p>【UE-&gt;MME】 attach request（old GUTI）<br>【MME】 IMSI，old GUTI，MM上下文</p>
<p>如果在NAS-MAC完整性检查通过，MME可能不执行鉴权，NAS安全建立和位置更新立即建立EPS会话/默认EPS承载。</p>
<p><strong>attach case-5：known UE，MME changed</strong></p>
<p>UE使用old GUTI来请求初始附着。所以new MME向old MME请求上次UE上下文信息，并获取UE的IMSI和MM上下文。</p>
<p>【UE-&gt;new MME】 attach request（old GUTI）<br>【new MME-&gt;old MME】identification request(old GUTI)<br>【old MME】IMSI，old GUTI，MM上下文<br>【new MME&lt;-old MME】identification response（IMSI，old GUTI，MM上下文）</p>
<p>如果old MME的NAS-MAC完整性检查通过，new MME介绍接收到IMSI和MM上下文，就不执行鉴权和NAS安全建立。但是因为MME发生了改变，new MME需要和HSS通信来更新UE位置信息，并建立EPS会话/默认EPS承载。HSS从old MME到new MME更新UE的位置信息，并发送cancel Location消息给old MME来通知UE的MM上下文信息可以从old MME中删除了。</p>
<h1 id="IV-Closing"><a href="#IV-Closing" class="headerlink" title="IV. Closing"></a>IV. Closing</h1><p>到目前为止，我们讨论了初始附着的不同类型，并且不同类型所需要的步骤。在接下来的文档中，我们将关注详细的初始附着过程，并探讨在这些附着过程中在EPS实体中有哪些信息需要设置。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “Eleven EMM Cases in an EMM Scenario”, October 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002</a><br>[2] Netmanias Technical Document, “LTE Security II: NAS and AS Security”, August 2013,<br><a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5903</a><br>[3] Netmanias Technical Document, “LTE Security I: LTE Security Concept and LTE Authentication”, July<br>2013, <a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5902" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=5902</a><br>[4] NMC Consulting Group Confidential Internal Report, “E2E LTE Network Design”, August 2010.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/9-EMM-Scenario-and-Eleven-EMM-Cases/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sun-day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sun-day-blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/9-EMM-Scenario-and-Eleven-EMM-Cases/" itemprop="url">9-EMM Scenario and Eleven EMM Cases</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T22:18:53+08:00">2018-04-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/" itemprop="url" rel="index"><span itemprop="name">通信</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/通信/LTE/" itemprop="url" rel="index"><span itemprop="name">LTE</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文地址：<a href="http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002" target="_blank" rel="noopener">http://www.netmanias.com/en/?m=view&amp;id=techdocs&amp;no=6002</a></p>
<p><img src="http://img.blog.csdn.net/20150909103728607" alt="这里写图片描述"><br>NOTE：初始状态，UE A是关机的，并且在网络中没有UE A的UE上下文存在。</p>
<hr>
<h3 id="EMM-case-1，Initial-Attach（初始附着）"><a href="#EMM-case-1，Initial-Attach（初始附着）" class="headerlink" title="EMM case 1，Initial Attach（初始附着）"></a>EMM case 1，Initial Attach（初始附着）</h3><p><img src="http://img.blog.csdn.net/20150909103827004" alt="这里写图片描述"><br>UE状态：“EMM-Deregistered，ECM/RRC-Idle”–&gt;“EMM-Registered，ECM/RRC-Connected”</p>
<ul>
<li>UE A开机，UE A进入“EMM-Deregistered，ECM/RRC-Idle”并试图接入网络。</li>
<li>在UE A和MME中没有UE A的UE上下文</li>
<li>在同步到一个小区之后，UE A用IMSI作为UE ID发送Attach Request给MMT来发起initial attach过程</li>
<li>在成功完成initial attach之后，UE A进入“EMM-Registered，ECM/RRC-Connected”状态并使用注册的服务。</li>
</ul>
<hr>
<h3 id="EMM-case-2，Detach（去附着）"><a href="#EMM-case-2，Detach（去附着）" class="headerlink" title="EMM case 2，Detach（去附着）"></a>EMM case 2，Detach（去附着）</h3><p><img src="http://img.blog.csdn.net/20150909104428534" alt="这里写图片描述"><br>UE状态：“EMM-Registered，ECM/RRC-Connected”–&gt;“EMM-Deregistered，ECM/RRC-Idle”</p>
<ul>
<li>UE A在“EMM-Registered，ECM/RRC-Connected”状态下从网络去附着。</li>
<li>根据detach触发的原因，有三种类型的detach过程（UE发起的，MME发起的和HSS发起的）。</li>
<li>一旦成功完成了Detach过程之后，UE A进入”EMM-Deregistered，ECM/RRC-Idle”状态</li>
</ul>
<hr>
<h3 id="EMM-case-3，由于用户不活动释放S1"><a href="#EMM-case-3，由于用户不活动释放S1" class="headerlink" title="EMM case 3，由于用户不活动释放S1"></a>EMM case 3，由于用户不活动释放S1</h3><p><img src="http://img.blog.csdn.net/20150909105015317" alt="这里写图片描述"><br>UE状态：“EMM-Registered，ECM/RRC-Connected”–&gt;“EMM-Registered，ECM/RRC-Idle”</p>
<ul>
<li>在“EMM-Registered，ECM/RRC-Connected”状态下在一段时间内UE A没有使用服务。</li>
<li>eNB检测到用户的不活动，释放S1承载和S1信令连接。</li>
<li>在成功完成S1释放过程后，UE A进入“EMM-Registered，ECM/RRC-Idle”状态。</li>
</ul>
<hr>
<h3 id="EMM-case-4，由于新的业务发起服务请求"><a href="#EMM-case-4，由于新的业务发起服务请求" class="headerlink" title="EMM case 4，由于新的业务发起服务请求"></a>EMM case 4，由于新的业务发起服务请求</h3><p><img src="http://img.blog.csdn.net/20150909105754350" alt="这里写图片描述"><br>UE状态：“EMM-Registered，ECM/RRC-Idle”—&gt;“EMM-Registered，ECM/RRC-Connected”</p>
<ul>
<li>UE A在“EMM-Registered，ECM/RRC-Idle”状态下产生了新的业务。</li>
<li>新的业务可以由UE A产生也可以由网络产生，并发起服务请求过程。</li>
<li>在成功完成服务请求过程之后，UE A进入“EMM-Registered，ECM/RRC-Connected”状态。</li>
</ul>
<hr>
<h3 id="EMM-case-5，TAU"><a href="#EMM-case-5，TAU" class="headerlink" title="EMM case 5，TAU"></a>EMM case 5，TAU</h3><p><img src="http://img.blog.csdn.net/20150909110642528" alt="这里写图片描述"><br>UE状态：“EMM-Registered，ECM/RRC-Idle”—&gt;“EMM-Registered，ECM/RRC-Connected”—&gt;“EMM-Registered，ECM/RRC-Idle”</p>
<ul>
<li>UE A在“EMM-Registered，ECM/RRC-Idle”状态，且周期性TAU定时器（T3412）超时。</li>
<li>UE A执行周期性TAU过程，UE A建立到MME的ECM连接，发送TAU Request消息并转移到“EMM-Registered，ECM/RRC-Connected”状态。</li>
<li>在成功完成周期性TAU过程之后，释放ECM连接并且UE A进入“EMM-Registered，ECM/RRC-Idle”状态。</li>
</ul>
<hr>
<h3 id="EMM-case-6，没有TAU的切换"><a href="#EMM-case-6，没有TAU的切换" class="headerlink" title="EMM case 6，没有TAU的切换"></a>EMM case 6，没有TAU的切换</h3><p><img src="http://img.blog.csdn.net/20150909111502547" alt="这里写图片描述"><br>UE状态：“EMM-Registered，ECM/RRC-Connected”–&gt;“EMM-Registered，ECM/RRC-Connected”</p>
<ul>
<li>UE A在“EMM-Registered，ECM/RRC-Connected”状态，移动到一个新的小区，并且检测到这个新进入的TA包含在TAI列表中。</li>
<li>执行切换到新的小区，但是不需要执行TAU过程。</li>
<li>在成功完成切换之后，UE A保持在“EMM-Registered，ECM/RRC-Connected”状态。</li>
</ul>
<hr>
<h3 id="EMM-case-7，没有TAU的小区重选"><a href="#EMM-case-7，没有TAU的小区重选" class="headerlink" title="EMM case 7，没有TAU的小区重选"></a>EMM case 7，没有TAU的小区重选</h3><p><img src="http://img.blog.csdn.net/20150909112029992" alt="这里写图片描述"><br>UE状态：“EMM-Registered，ECM/RRC-Idle”–&gt;“EMM-Registered，ECM/RRC-Idle”</p>
<ul>
<li>UE A在“EMM-Registered，ECM/RRC-Idle”状态，移动到一个新的小区，并且检测到这个新进入的TA包含在TAI列表中。</li>
<li>执行重选到新的小区，但是不需要执行TAU过程。</li>
<li>在成功完成重选过程之后，UE A保持在“EMM-Registered，ECM/RRC-Idle”状态。</li>
</ul>
<hr>
<h3 id="EMM-case-8，包含TAU的切换"><a href="#EMM-case-8，包含TAU的切换" class="headerlink" title="EMM case 8，包含TAU的切换"></a>EMM case 8，包含TAU的切换</h3><p><img src="http://img.blog.csdn.net/20150909112237420" alt="这里写图片描述"><br>UE状态：“EMM-Registered，ECM/RRC-Connected”–&gt;“EMM-Registered，ECM/RRC-Connected”</p>
<ul>
<li>UE A在“EMM-Registered，ECM/RRC-Connected”状态，移动到一个新的小区，并且检测到这个新进入的TA不包含在TAI列表中。</li>
<li>执行切换到新的小区，并且需要执行TAU过程。</li>
<li>在成功完成切换之后，UE A保持在“EMM-Registered，ECM/RRC-Connected”状态。</li>
</ul>
<hr>
<h3 id="EMM-case-9，包含TAU的小区重选"><a href="#EMM-case-9，包含TAU的小区重选" class="headerlink" title="EMM case 9，包含TAU的小区重选"></a>EMM case 9，包含TAU的小区重选</h3><p><img src="http://img.blog.csdn.net/20150909112409558" alt="这里写图片描述"><br>UE状态：“EMM-Registered，ECM/RRC-Idle”–&gt;“EMM-Registered，ECM/RRC-Connected”–&gt;“EMM-Registered，ECM/RRC-Idle”</p>
<ul>
<li>UE A在“EMM-Registered，ECM/RRC-Idle”状态，移动到一个新的小区，并且检测到这个新进入的TA不包含在TAI列表中。</li>
<li>执行重选到新的小区，并且需要执行TAU过程。UE A建立到MME的ECM连接并发送TAU Request消息，转移到“EMM-Registered，ECM/RRC-Connected”状态。</li>
<li>在成功完成TAU更新过程之后，UE A进入“EMM-Registered，ECM/RRC-Idle”状态。</li>
</ul>
<hr>
<h3 id="EMM-case-10，移动到另一个城市"><a href="#EMM-case-10，移动到另一个城市" class="headerlink" title="EMM case 10，移动到另一个城市"></a>EMM case 10，移动到另一个城市</h3><p><img src="http://img.blog.csdn.net/20150909112737616" alt="这里写图片描述"><br>UE状态：“EMM-Registered，ECM/RRC-Connected”–&gt;“EMM-Registered，ECM/RRC-Idle”–&gt;“EMM-Deregistered，ECM/RRC-Idle”</p>
<ul>
<li>UE A从城市1（正在服务或者在idle状态）移动到城市2。UE A移出了LTE的覆盖区外，并且从网络detach。</li>
<li>在detach过程之后，UE A进入“EMM-Deregistered，ECM/RRC-Idle”状态。</li>
</ul>
<hr>
<h3 id="EMM-case-11，在另一个城市初始附着"><a href="#EMM-case-11，在另一个城市初始附着" class="headerlink" title="EMM case 11，在另一个城市初始附着"></a>EMM case 11，在另一个城市初始附着</h3><p><img src="http://img.blog.csdn.net/20150909113113163" alt="这里写图片描述"><br>UE状态：“EMM-Deregistered，ECM/RRC-Idle”–&gt;“EMM-Registered，ECM/RRC-Connected”</p>
<ul>
<li>UE A在“EMM-Deregistered，ECM/RRC-Idle”状态，进入到城市2，并且检测到一个新的LTE小区。</li>
<li>UE A用GUTI作为UE ID发送Attach Request小区给新的MME发起初始附着过程。</li>
<li>在成功完成初始附着过程之后，UE A进入“EMM-Registered，ECM/RRC-Connected”状态。</li>
</ul>
<hr>
<p><img src="http://img.blog.csdn.net/20150909113559035" alt="这里写图片描述"></p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] Netmanias Technical Document, “LTE EMM and ECM State”, February 2013,<br><a href="http://www.netmanias.com/bbs/zboard.php?id=1x_TechdocsForum_4G" target="_blank" rel="noopener">http://www.netmanias.com/bbs/zboard.php?id=1x_TechdocsForum_4G</a><br>[2] 3GPP TS 24.301, “Non-Access-Stratum (NAS) Protocol for Evolved Packet System (EPS); Stage 3”.<br>[3] 3GPP TS 23.401, “General Packet Radio Service (GPRS) Enhancements for Evolved Universal Terrestrial Radio Access Network<br>(E-UTRAN) Access“.<br>[4] NMC Consulting Group Report, “E2E LTE Network Design”, August 2010.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">sun-day</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sun-day</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
