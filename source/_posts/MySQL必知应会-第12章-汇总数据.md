---
title: MySQL必知应会-第12章-汇总数据
date: 2018-04-13 18:02:51
tags:
 - mysql
 - 数据库
categories:
 - mysql
 - 数据库
---


# 第12章 汇总数据
本章介绍什么是SQL的聚集函数以及如何利用它们汇总表的数据。

## 12.1 聚集函数
我们经常需要汇总数据而不用把它们实际检索出来，为此MySQL提供了专门的函数。使用这些函数， MySQL查询可用于检索数据，以便分析和报表生成。这种类型的检索例子有以下几种。
 - 确定表中行数（或者满足某个条件或包含某个特定值的行数）。 
 - 获得表中行组的和。 
 - 找出表列（或所有行或某些特定的行）的最大值、最小值和平均值。
上述例子都需要对表中数据（而不是实际数据本身）汇总。因此，返回实际表数据是对时间和处理资源的一种浪费（更不用说带宽了）。重复一遍，实际想要的是汇总信息。为方便这种类型的检索， MySQL给出了5个聚集函数，见表12-1。这些函数能进行上述罗列的检索。聚集函数（ aggregate function） 运行在行组上，计算和返回单个值的函数。
Snipaste_2018-04-13_18-54-18.png

以下说明各函数的使用。
标准偏差 MySQL还支持一系列的标准偏差聚集函数，但本书并未涉及这些内容。

## 12.1.1 AVG()函数
AVG()通过对表中行数计数并计算特定列值之和，求得该列的平均值。 AVG()可用来返回所有列的平均值，也可以用来返回特定列或行的平均值。下面的例子使用AVG()返回products表中所有产品的平均价格：
Snipaste_2018-04-13_18-55-42.png

此SELECT语句返回值avg_Price，它包含products表中所有产品的平均价格。如第10章所述， avg_price是一个别名。AVG()也可以用来确定特定列或行的平均值。下面的例子返回特定供应商所提供产品的平均价格：
Snipaste_2018-04-13_18-56-43.png

这条SELECT语句与前一条的不同之处在于它包含了WHERE子句。此WHERE子句仅过滤出vend_id为1003的产品，因此avg_price中返回的值只是该供应商的产品的平均值。
只用于单个列 AVG()只能用来确定特定数值列的平均值，而且列名必须作为函数参数给出。为了获得多个列的平均值，必须使用多个AVG()函数。
NULL值 AVG()函数忽略列值为NULL的行。

## 12.1.2 COUNT()函数
COUNT()函数进行计数。可利用COUNT()确定表中行的数目或符合特定条件的行的数目。COUNT()函数有两种使用方式。
 - 使用COUNT(\*)对表中行的数目进行计数， 不管表列中包含的是空值（NULL）还是非空值。
 - 使用COUNT(column)对特定列中具有值的行进行计数，忽略NULL值。下面的例子返回customers表中客户的总数：
Snipaste_2018-04-13_18-58-57.png

在此例子中，利用COUNT(\*)对所有行计数，不管行中各列有什么值。计数值在num_cust中返回。
下面的例子只对具有电子邮件地址的客户计数：
Snipaste_2018-04-13_19-00-39.png

这条SELECT语句使用COUNT(cust_email)对cust_email列中有值的行进行计数。在此例子中， cust_email的计数为3（表示5个客户中只有3个客户有电子邮件地址）。
NULL值 如果指定列名，则指定列的值为空的行被COUNT()函数忽略，但如果COUNT()函数中用的是星号（ \*），则不忽略。

### 12.1.3 MAX()函数
MAX()返回指定列中的最大值。 MAX()要求指定列名，如下所示：
Snipaste_2018-04-13_19-02-00.png

这里， MAX()返回products表中最贵的物品的价格。
对非数值数据使用MAX() 虽然MAX()一般用来找出最大的数值或日期值，但MySQL允许将它用来返回任意列中的最大值，包括返回文本列中的最大值。在用于文本数据时，如果数据按相应的列排序，则MAX()返回最后一行。
NULL值 MAX()函数忽略列值为NULL的行。

### 12.1.4 MIN()函数
MIN()的功能正好与MAX()功能相反，它返回指定列的最小值。与MAX()一样， MIN()要求指定列名，如下所示：
Snipaste_2018-04-13_19-03-15.png

其中MIN()返回products表中最便宜物品的价格。
对非数值数据使用MIN() MIN()函数与MAX()函数类似，MySQL允许将它用来返回任意列中的最小值，包括返回文本列中的最小值。在用于文本数据时，如果数据按相应的列排序，则MIN()返回最前面的行。
NULL值 MIN()函数忽略列值为NULL的行。

### 12.1.5 SUM()函数
SUM()用来返回指定列值的和（总计）。下面举一个例子， orderitems表包含订单中实际的物品，每个物品有相应的数量（quantity）。可如下检索所订购物品的总数（所有quantity值之和）：
Snipaste_2018-04-13_19-04-55.png

函数SUM(quantity)返回订单中所有物品数量之和， WHERE子句保证只统计某个物品订单中的物品。SUM()也可以用来合计计算值。在下面的例子中，合计每项物品的item_price\*quantity，得出总的订单金额：
Snipaste_2018-04-13_19-05-47.png

函数SUM(item_price\*quantity)返回订单中所有物品价钱之和， WHERE子句同样保证只统计某个物品订单中的物品。
在多个列上进行计算 如本例所示，利用标准的算术操作符，所有聚集函数都可用来执行多个列上的计算。
NULL值 SUM()函数忽略列值为NULL的行。

## 12.2 聚集不同值
MySQL 5 及 后 期 版 本 下 面 将 要 介 绍 的 聚 集 函 数 的DISTINCT的使用，已经被添加到MySQL 5.0.3中。下面所述内容在MySQL 4.x中不能正常运行。以上5个聚集函数都可以如下使用：
 - 对所有的行执行计算，指定ALL参数或不给参数（因为ALL是默认行为）； 
 - 只包含不同的值，指定DISTINCT参数。
ALL为默认 ALL参数不需要指定，因为它是默认行为。如果不指定DISTINCT，则假定为ALL。
下面的例子使用AVG()函数返回特定供应商提供的产品的平均价格。它与上面的SELECT语句相同，但使用了DISTINCT参数，因此平均值只考虑各个不同的价格：
Snipaste_2018-04-13_19-08-43.png

可以看到，在使用了DISTINCT后，此例子中的avg_price比较高，因为有多个物品具有相同的较低价格。排除它们提升了平均价格。注意 如果指定列名，则DISTINCT只能用于COUNT()。DISTINCT不能用于COUNT(\*)，因此不允许使用COUNT（ DISTINCT），否则会产生错误。类似地， DISTINCT必须使用列名，不能用于计算或表达式。
将DISTINCT用于MIN()和MAX() 虽然DISTINCT从技术上可用于MIN()和MAX()，但这样做实际上没有价值。一个列中的最小值和最大值不管是否包含不同值都是相同的。

## 12.3 组合聚集函数
目前为止的所有聚集函数例子都只涉及单个函数。但实际上SELECT语句可根据需要包含多个聚集函数。请看下面的例子：
Snipaste_2018-04-13_19-12-09.png

这里用单条SELECT语句执行了4个聚集计算，返回4个值（products表中物品的数目，产品价格的最高、最低以及平均值）。
取别名 在指定别名以包含某个聚集函数的结果时，不应该使用表中实际的列名。虽然这样做并非不合法，但使用唯一的名字会使你的SQL更易于理解和使用（以及将来容易排除故障）。

## 12.4 小结
聚集函数用来汇总数据。 MySQL支持一系列聚集函数，可以用多种方法使用它们以返回所需的结果。这些函数是高效设计的，它们返回结果一般比你在自己的客户机应用程序中计算要快得多。
